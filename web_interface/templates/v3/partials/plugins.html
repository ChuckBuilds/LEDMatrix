<div class="bg-white rounded-lg shadow-md p-6">
    <div class="section-header">
        <h2 class="text-xl font-bold text-gray-900 mb-1">Plugin Management</h2>
        <p class="text-sm text-gray-600">Manage installed plugins, configure settings, and browse the plugin store.</p>
    </div>

    <!-- Plugin Controls -->
    <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
        <div class="flex items-center space-x-4">
            <button id="refresh-plugins-btn" class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">
                <i class="fas fa-sync-alt mr-2"></i>Refresh Plugins
            </button>
            <button id="restart-display-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                <i class="fas fa-redo mr-2"></i>Restart Display
            </button>
        </div>
    </div>

    <!-- On-Demand Status -->
    <div id="on-demand-status-card" class="mb-6 p-4 border border-blue-200 rounded-lg bg-blue-50 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
        <div>
            <h3 class="text-base font-semibold text-blue-900">On-Demand Display</h3>
            <p id="on-demand-status-text" class="text-sm text-blue-700">No on-demand session active.</p>
            <p id="on-demand-service-hint" class="text-xs text-blue-600 mt-1"></p>
        </div>
        <div class="flex gap-2">
            <button id="on-demand-refresh-btn" class="px-3 py-2 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-md">
                <i class="fas fa-sync mr-1"></i>Refresh
            </button>
            <button id="stop-on-demand-btn" class="px-3 py-2 text-sm bg-red-600 hover:bg-red-700 text-white rounded-md hidden"
                    title="Shift-click to stop the display service as well">
                <i class="fas fa-stop mr-1"></i>Stop On-Demand
            </button>
        </div>
    </div>

    <!-- Plugin Content Area -->
    <div id="plugins-content" class="space-y-8">
        <!-- Installed Plugins Section (Always visible at top) -->
        <div id="installed-plugins-section" class="mb-8">
            <div class="flex items-center justify-between mb-5 pb-3 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <h3 class="text-lg font-bold text-gray-900">Installed Plugins</h3>
                    <span id="installed-count" class="text-sm text-gray-500 font-medium">0 installed</span>
                </div>
                <button id="toggle-installed-plugins" class="text-sm text-gray-600 hover:text-gray-900 hover:text-blue-600 transition-colors flex items-center font-medium">
                    <i class="fas fa-chevron-down mr-1" id="installed-plugins-icon"></i>
                    <span>Collapse</span>
                </button>
            </div>
            <div id="installed-plugins-content" class="block">
                <div id="installed-plugins-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6">
                    <!-- Plugins will be loaded here -->
                </div>
            </div>
        </div>

        <!-- Plugin Store Section (Always visible at bottom) -->
        <div id="plugin-store-section" class="border-t border-gray-200 pt-8 mt-8">
            <div class="flex items-center justify-between mb-5 pb-3 border-b border-gray-200">
                <div class="flex items-center gap-3">
                    <h3 class="text-lg font-bold text-gray-900">Plugin Store</h3>
                    <span id="store-count" class="text-sm text-gray-500 font-medium">
                        <i class="fas fa-spinner fa-spin mr-1"></i>Loading...
                    </span>
                </div>
                <button id="toggle-plugin-store" class="text-sm text-gray-600 hover:text-gray-900 hover:text-blue-600 transition-colors flex items-center font-medium">
                    <i class="fas fa-chevron-down mr-1" id="plugin-store-icon"></i>
                    <span>Collapse</span>
                </button>
            </div>
            
            <div id="plugin-store-content" class="block">
            
            <!-- GitHub Auth Warning Banner (only shown when no token is configured) -->
            <div id="github-auth-warning" class="hidden mb-5 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-r-lg" style="display: none;">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm text-yellow-700">
                            <strong>Limited API Access:</strong> GitHub API requests are limited to <span id="rate-limit-count">60</span> per hour without authentication.
                            Add a GitHub token to increase this to 5,000 requests/hour and get real-time plugin stats.
                        </p>
                        <p class="mt-2 text-sm text-yellow-700">
                            <a href="https://github.com/settings/tokens/new?description=LEDMatrix%20Plugin%20Manager&scopes=" target="_blank" class="font-medium underline hover:text-yellow-800">
                                Create a GitHub Token →
                            </a>
                            <span class="mx-2">|</span>
                            <a href="#" onclick="event.preventDefault(); toggleGithubTokenSettings()" class="font-medium underline hover:text-yellow-800">
                                Configure Token
                            </a>
                        </p>
                    </div>
                    <div class="flex-shrink-0">
                        <button onclick="dismissGithubWarning()" class="text-yellow-700 hover:text-yellow-900">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- GitHub Token Configuration Section -->
            <div id="github-token-settings" class="hidden mb-5 bg-blue-50 border border-blue-200 rounded-lg p-5 shadow-sm" style="display: none;">
                <div class="flex items-start justify-between mb-4">
                    <div class="flex items-center space-x-2">
                        <i class="fab fa-github text-blue-600 text-xl"></i>
                        <h4 class="font-bold text-gray-900">GitHub API Configuration</h4>
                    </div>
                    <div class="flex items-center gap-2">
                        <button id="toggle-github-token-collapse" class="text-gray-600 hover:text-gray-900 text-sm flex items-center font-medium transition-colors">
                            <i class="fas fa-chevron-up mr-1" id="github-token-icon-collapse"></i>
                            <span>Collapse</span>
                        </button>
                        <button onclick="toggleGithubTokenSettings()" class="text-gray-500 hover:text-gray-700 transition-colors">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                
                <div id="github-token-content" class="block">
                
                <p class="text-sm text-gray-600 mb-3">
                    Configure your GitHub Personal Access Token to increase API rate limits and get real-time plugin statistics.
                </p>

                <div class="space-y-3">
                    <div>
                        <label for="github-token-input" class="block text-sm font-medium text-gray-700 mb-1">
                            GitHub Personal Access Token
                        </label>
                        <div class="relative">
                            <input type="password" id="github-token-input" 
                                   class="w-full px-3 py-2 pr-20 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                            <button type="button" onclick="toggleGithubTokenVisibility()" 
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700">
                                <i id="github-token-icon" class="fas fa-eye"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            Token is stored in config_secrets.json. No scopes required for public repositories.
                        </p>
                    </div>

                    <div class="flex items-center justify-between">
                        <a href="https://github.com/settings/tokens/new?description=LEDMatrix%20Plugin%20Manager&scopes=" 
                           target="_blank" 
                           class="text-sm text-blue-600 hover:text-blue-800">
                            <i class="fas fa-external-link-alt mr-1"></i>Create Token on GitHub
                        </a>
                        <div class="flex gap-2">
                            <button onclick="loadGithubToken()" class="px-3 py-1.5 text-sm bg-gray-600 hover:bg-gray-700 text-white rounded-md">
                                <i class="fas fa-sync mr-1"></i>Load Current
                            </button>
                            <button onclick="saveGithubToken()" class="px-4 py-1.5 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-md">
                                <i class="fas fa-save mr-1"></i>Save Token
                            </button>
                        </div>
                    </div>

                    <div class="bg-white border border-blue-200 rounded p-3">
                        <p class="text-xs text-gray-600">
                            <strong>Rate Limits:</strong><br>
                            Without token: 60 requests/hour<br>
                            With token: 5,000 requests/hour
                        </p>
                    </div>
                </div>
                </div>
            </div>
            <div class="mb-6">
                <div class="flex gap-3">
                    <input type="text" id="plugin-search" placeholder="Search plugins by name, description, or tags..." class="form-control text-sm flex-[3] min-w-0 px-4 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:shadow-md transition-shadow">
                    <select id="plugin-category" class="form-control text-sm flex-1 px-3 py-2.5 border border-gray-300 rounded-lg shadow-sm focus:shadow-md transition-shadow">
                        <option value="">All Categories</option>
                        <option value="sports">Sports</option>
                        <option value="content">Content</option>
                        <option value="time">Time</option>
                        <option value="weather">Weather</option>
                        <option value="financial">Financial</option>
                        <option value="media">Media</option>
                        <option value="demo">Demo</option>
                    </select>
                    <button id="search-plugins-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white px-5 py-2.5 rounded-lg whitespace-nowrap font-semibold shadow-sm">
                        <i class="fas fa-search mr-2"></i>Search
                    </button>
                </div>
            </div>
            <div id="plugin-store-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-6">
                <!-- Loading skeleton -->
                <div class="store-loading col-span-full">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                        <div class="bg-gray-200 rounded-lg p-4 h-48 animate-pulse"></div>
                        <div class="bg-gray-200 rounded-lg p-4 h-48 animate-pulse"></div>
                        <div class="bg-gray-200 rounded-lg p-4 h-48 animate-pulse"></div>
                        <div class="bg-gray-200 rounded-lg p-4 h-48 animate-pulse"></div>
                        <div class="bg-gray-200 rounded-lg p-4 h-48 animate-pulse"></div>
                </div>
            </div>
            </div>
        </div>
        
        <!-- Install from GitHub URL Section (Separate section, always visible) -->
        <div class="border-t border-gray-200 pt-8 mt-8">
            <div class="flex items-center justify-between mb-5 pb-3 border-b border-gray-200">
                <div>
                    <h3 class="text-lg font-bold text-gray-900">Install from GitHub</h3>
                    <p class="text-sm text-gray-600 mt-1">Install plugins directly from GitHub repositories</p>
                </div>
                <button id="toggle-github-install" class="text-sm text-blue-600 hover:text-blue-800 flex items-center font-medium transition-colors">
                    <i class="fas fa-chevron-down mr-1" id="github-install-icon"></i>
                    <span>Show</span>
                </button>
            </div>
            
            <div id="github-install-section" class="hidden space-y-4">
                <!-- Saved Repositories Section -->
                <div class="bg-blue-50 rounded-lg p-5 border border-blue-200 shadow-sm">
                    <div class="flex items-center justify-between mb-4">
                        <h4 class="text-base font-bold text-gray-900">
                            <i class="fas fa-bookmark mr-2 text-blue-600"></i>Saved Repositories
                        </h4>
                        <span id="saved-repos-count" class="text-xs text-gray-600 font-medium">0 saved</span>
                    </div>
                    <p class="text-xs text-gray-600 mb-3">Saved repositories are automatically loaded and their plugins appear in the Plugin Store above.</p>
                    <div id="saved-repositories-list" class="space-y-2 mb-3">
                        <!-- Saved repositories will be loaded here -->
                    </div>
                    <button id="refresh-saved-repos" class="text-xs text-blue-600 hover:text-blue-800">
                        <i class="fas fa-sync mr-1"></i>Refresh
                    </button>
                </div>
                
                <!-- Direct Plugin Installation -->
                <div class="bg-gray-50 rounded-lg p-5 border border-gray-200 shadow-sm">
                    <h4 class="text-base font-bold text-gray-900 mb-3">
                        <i class="fas fa-code-branch mr-2 text-blue-600"></i>Install Single Plugin
                    </h4>
                    <p class="text-xs text-gray-600 mb-3">Install a plugin directly from its GitHub repository URL</p>
                    <div class="flex gap-2">
                        <input type="text" id="github-plugin-url" 
                               placeholder="https://github.com/user/ledmatrix-plugin-name" 
                               class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <button id="install-plugin-from-url" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-md whitespace-nowrap">
                            <i class="fas fa-download mr-2"></i>Install
                        </button>
                    </div>
                    <div id="github-plugin-status" class="mt-2 text-sm"></div>
                </div>
                
                <!-- Registry-Style Monorepo Installation -->
                <div class="bg-gray-50 rounded-lg p-5 border border-gray-200 shadow-sm">
                    <h4 class="text-base font-bold text-gray-900 mb-3">
                        <i class="fas fa-folder-open mr-2 text-green-600"></i>Browse Plugin Registry
                    </h4>
                    <p class="text-xs text-gray-600 mb-3">Load a registry-style monorepo (like the official ledmatrix-plugins repo) to browse and install plugins</p>
                    <div class="flex gap-2 mb-2">
                        <input type="text" id="github-registry-url" 
                               placeholder="https://github.com/user/ledmatrix-plugins" 
                               class="flex-1 px-3 py-2 text-sm border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                        <button id="load-registry-from-url" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white text-sm rounded-md whitespace-nowrap">
                            <i class="fas fa-search mr-2"></i>Load Registry
                        </button>
                    </div>
                    <div class="flex gap-2 mb-3">
                        <button id="save-registry-url" class="px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-md whitespace-nowrap">
                            <i class="fas fa-bookmark mr-2"></i>Save Repository
                        </button>
                        <div id="registry-status" class="flex-1 text-sm"></div>
                    </div>
                    <div id="custom-registry-plugins" class="hidden">
                        <div class="border-t border-gray-300 pt-3 mt-3">
                            <p class="text-xs font-medium text-gray-700 mb-2">Available Plugins:</p>
                            <div id="custom-registry-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                <!-- Custom registry plugins will be loaded here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    </div>

    <!-- Plugin Configuration Modal -->
    <div id="plugin-config-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" style="display: none;">
        <div class="modal-content p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="plugin-config-title" class="text-lg font-semibold">Plugin Configuration</h3>
                <button id="close-plugin-config" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="plugin-config-content">
                <!-- Plugin config form will be loaded here -->
            </div>
        </div>
    </div>
</div>

<!-- On-Demand Modal -->
<div id="on-demand-modal" class="fixed inset-0 modal-backdrop flex items-center justify-center z-50" style="display: none;">
    <div class="modal-content p-6 w-full max-w-md bg-white rounded-lg shadow-lg">
        <div class="flex justify-between items-center mb-4">
            <h3 id="on-demand-modal-title" class="text-lg font-semibold">Run Plugin On-Demand</h3>
            <button id="close-on-demand-modal" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <!-- Service Status Alert -->
        <div id="on-demand-service-warning" class="hidden mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded-md">
            <div class="flex items-start">
                <i class="fas fa-exclamation-triangle text-yellow-600 mt-0.5 mr-2"></i>
                <div class="flex-1">
                    <p class="text-sm font-medium text-yellow-800">Display service is not running</p>
                    <p class="text-xs text-yellow-700 mt-1">
                        The on-demand request will be queued but won't display until the service starts.
                        Enable "Start display service" below to automatically start it.
                    </p>
                </div>
            </div>
        </div>
        
        <form id="on-demand-form" class="space-y-4">
            <div>
                <label for="on-demand-mode" class="block text-sm font-medium text-gray-700 mb-1">Display Mode</label>
                <select id="on-demand-mode" name="mode"
                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500">
                </select>
                <p id="on-demand-mode-hint" class="text-xs text-gray-500 mt-1"></p>
            </div>
            <div>
                <label for="on-demand-duration" class="block text-sm font-medium text-gray-700 mb-1">
                    Duration (seconds, optional)
                </label>
                <input type="number" min="0" id="on-demand-duration" name="duration"
                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                       placeholder="Leave blank to use plugin default">
                <p class="text-xs text-gray-500 mt-1">
                    Use 0 or leave empty to keep the plugin running until stopped manually.
                </p>
            </div>
            <div class="flex items-center">
                <input id="on-demand-pinned" name="pinned" type="checkbox"
                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="on-demand-pinned" class="ml-2 block text-sm text-gray-700">
                    Pin plugin to prevent rotation until stopped
                </label>
            </div>
            <div class="flex items-center">
                <input id="on-demand-start-service" name="start_service" type="checkbox" checked
                       class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <label for="on-demand-start-service" class="ml-2 block text-sm text-gray-700">
                    Start display service if it is not running
                </label>
            </div>
            <div class="flex justify-end gap-3 pt-3">
                <button type="button" id="cancel-on-demand"
                        class="px-4 py-2 text-sm bg-gray-200 hover:bg-gray-300 text-gray-700 rounded-md">
                    Cancel
                </button>
                <button type="submit"
                        class="px-4 py-2 text-sm bg-green-600 hover:bg-green-700 text-white rounded-md font-semibold">
                    Start On-Demand
                </button>
            </div>
        </form>
    </div>
</div>

<style>
/* Nested config section styles */
.nested-section {
    transition: all 0.2s ease;
}

.nested-section button:hover {
    background-color: #f3f4f6;
}

.nested-section .nested-content {
    transition: all 0.3s ease;
}

.nested-section i {
    transition: transform 0.3s ease;
}

/* Smooth toggle animation */
.nested-content[style*="display: none"] {
    opacity: 0;
    max-height: 0;
    overflow: hidden;
}

.nested-content[style*="display: block"] {
    opacity: 1;
    max-height: none;
}

/* Nested sections within nested sections - add indentation */
.nested-content .nested-section {
    margin-left: 1rem;
}

/* Form group spacing within nested sections */
.nested-content .form-group {
    margin-bottom: 0.75rem;
}

/* Make nested section headers slightly smaller for hierarchy */
.nested-content .nested-section h4 {
    font-size: 0.95em;
}
</style>

<script>
(function() {
    'use strict';

    console.log('Plugin manager script starting...');
    
    // Local variables for this instance
let installedPlugins = [];
window.currentPluginConfig = null;
    let pluginStoreCache = null; // Cache for plugin store to speed up subsequent loads
    let cacheTimestamp = null;
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds
    let onDemandStatusInterval = null;
    let currentOnDemandPluginId = null;

// Initialize when DOM is ready or when HTMX loads content
window.initPluginsPage = function() {
    initializePlugins();

    // Event listeners (remove old ones first to prevent duplicates)
    const refreshBtn = document.getElementById('refresh-plugins-btn');
    const restartBtn = document.getElementById('restart-display-btn');
    const searchBtn = document.getElementById('search-plugins-btn');
    const closeBtn = document.getElementById('close-plugin-config');
    const onDemandRefreshBtn = document.getElementById('on-demand-refresh-btn');
    const stopOnDemandBtn = document.getElementById('stop-on-demand-btn');
    const closeOnDemandModalBtn = document.getElementById('close-on-demand-modal');
    const cancelOnDemandBtn = document.getElementById('cancel-on-demand');
    const onDemandForm = document.getElementById('on-demand-form');
    const onDemandModal = document.getElementById('on-demand-modal');
    
    if (refreshBtn) {
        refreshBtn.replaceWith(refreshBtn.cloneNode(true));
        document.getElementById('refresh-plugins-btn').addEventListener('click', refreshPlugins);
    }
    if (restartBtn) {
        restartBtn.replaceWith(restartBtn.cloneNode(true));
        document.getElementById('restart-display-btn').addEventListener('click', restartDisplay);
    }
    if (searchBtn) {
        searchBtn.replaceWith(searchBtn.cloneNode(true));
        document.getElementById('search-plugins-btn').addEventListener('click', searchPluginStore);
    }
    if (closeBtn) {
        closeBtn.replaceWith(closeBtn.cloneNode(true));
        document.getElementById('close-plugin-config').addEventListener('click', closePluginConfigModal);
    }
    if (onDemandRefreshBtn) {
        onDemandRefreshBtn.replaceWith(onDemandRefreshBtn.cloneNode(true));
        document.getElementById('on-demand-refresh-btn').addEventListener('click', () => loadOnDemandStatus(true));
    }
    if (stopOnDemandBtn) {
        stopOnDemandBtn.replaceWith(stopOnDemandBtn.cloneNode(true));
        document.getElementById('stop-on-demand-btn').addEventListener('click', (event) => stopOnDemand(event));
    }
    if (closeOnDemandModalBtn) {
        closeOnDemandModalBtn.replaceWith(closeOnDemandModalBtn.cloneNode(true));
        document.getElementById('close-on-demand-modal').addEventListener('click', closeOnDemandModal);
    }
    if (cancelOnDemandBtn) {
        cancelOnDemandBtn.replaceWith(cancelOnDemandBtn.cloneNode(true));
        document.getElementById('cancel-on-demand').addEventListener('click', closeOnDemandModal);
    }
    if (onDemandForm) {
        onDemandForm.replaceWith(onDemandForm.cloneNode(true));
        document.getElementById('on-demand-form').addEventListener('submit', submitOnDemandRequest);
    }
    if (onDemandModal) {
        onDemandModal.onclick = closeOnDemandModalOnBackdrop;
    }

    loadOnDemandStatus();
    startOnDemandStatusPolling();
}

// Initialize immediately when script loads (HTMX has already swapped content)
console.log('Plugin manager script loaded, initializing...');
// Small delay to ensure DOM is fully painted
setTimeout(function() {
    console.log('Checking for plugin elements...');
    if (document.getElementById('installed-plugins-grid')) {
        console.log('Plugin elements found, initializing now!');
        initPluginsPage();
    } else {
        console.error('Plugin elements not found!');
    }
}, 100);

function initializePlugins() {
    console.log('Initializing plugins...');

    // Check GitHub authentication status
    checkGitHubAuthStatus();

    // Load both installed plugins and plugin store
    loadInstalledPlugins();
    searchPluginStore(true); // Load plugin store with fresh metadata from GitHub

    // Setup search functionality
    document.getElementById('plugin-search').addEventListener('input', debounce(searchPluginStore, 300));
    document.getElementById('plugin-category').addEventListener('change', searchPluginStore);
    
    // Setup GitHub installation handlers
    setupGitHubInstallHandlers();
    
    // Setup collapsible section handlers
    setupCollapsibleSections();
    
    // Load saved repositories
    loadSavedRepositories();

    console.log('Plugins initialized');
}

function loadInstalledPlugins() {
    console.log('Loading installed plugins...');

    fetch('/api/v3/plugins/installed')
        .then(response => {
            console.log('Installed plugins response:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Installed plugins data:', data);

            if (data.status === 'success') {
                installedPlugins = data.data.plugins || [];
                console.log('Installed plugins count:', installedPlugins.length);
                renderInstalledPlugins(installedPlugins);

                // Update count
                const countEl = document.getElementById('installed-count');
                if (countEl) {
                    countEl.textContent = installedPlugins.length + ' installed';
                }
            } else {
                showError('Failed to load installed plugins: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error loading installed plugins:', error);
            showError('Error loading plugins: ' + error.message);
        });
}

function renderInstalledPlugins(plugins) {
    const container = document.getElementById('installed-plugins-grid');
    
    // Update global installedPlugins for navigation tabs
    window.installedPlugins = plugins;
    console.log('Set window.installedPlugins to:', plugins.length, 'plugins');
    
    // Trigger the main app to update plugin tabs
    if (window.Alpine && document.querySelector('[x-data="app()"]')) {
        const appElement = document.querySelector('[x-data="app()"]');
        if (appElement && appElement._x_dataStack && appElement._x_dataStack[0]) {
            appElement._x_dataStack[0].installedPlugins = plugins;
            appElement._x_dataStack[0].updatePluginTabs();
            console.log('Triggered Alpine.js to update plugin tabs');
        }
    }

    if (plugins.length === 0) {
        container.innerHTML = `
            <div class="col-span-full empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-plug"></i>
                </div>
                <p class="text-lg font-medium text-gray-700 mb-1">No plugins installed</p>
                <p class="text-sm text-gray-500">Install plugins from the store to get started</p>
            </div>
        `;
        return;
    }

    container.innerHTML = plugins.map(plugin => `
        <div class="plugin-card">
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center flex-wrap gap-2 mb-2">
                        <h4 class="font-semibold text-gray-900 text-base">${escapeHtml(plugin.name || plugin.id)}</h4>
                        ${plugin.verified ? '<span class="badge badge-success"><i class="fas fa-check-circle mr-1"></i>Verified</span>' : ''}
                    </div>
                    <div class="text-sm text-gray-600 space-y-1.5 mb-3">
                        <p class="flex items-center"><i class="fas fa-user mr-2 text-gray-400 w-4"></i>${escapeHtml(plugin.author || 'Unknown')}</p>
                        <p class="flex items-center"><i class="fas fa-code-branch mr-2 text-gray-400 w-4"></i>${formatCommit(plugin.last_commit, plugin.branch)}</p>
                        <p class="flex items-center"><i class="fas fa-calendar mr-2 text-gray-400 w-4"></i>${formatDate(plugin.last_updated)}</p>
                        <p class="flex items-center"><i class="fas fa-folder mr-2 text-gray-400 w-4"></i>${escapeHtml(plugin.category || 'General')}</p>
                        ${plugin.stars ? `<p class="flex items-center"><i class="fas fa-star mr-2 text-gray-400 w-4"></i>${plugin.stars} stars</p>` : ''}
                    </div>
                    <p class="text-sm text-gray-700 leading-relaxed">${escapeHtml(plugin.description || 'No description available')}</p>
                </div>
                <!-- Toggle Switch in Top Right -->
                <div class="flex-shrink-0 ml-4">
                    <label class="relative inline-flex items-center cursor-pointer group">
                        <input type="checkbox" 
                               class="sr-only peer" 
                               id="toggle-${plugin.id}"
                               ${plugin.enabled ? 'checked' : ''}
                               onchange="togglePlugin('${plugin.id}', this.checked)">
                        <div class="flex items-center gap-2 px-3 py-1.5 rounded-lg border-2 transition-all duration-200 ${plugin.enabled ? 'bg-green-50 border-green-500' : 'bg-gray-50 border-gray-300'} hover:shadow-md group-hover:scale-105">
                            <!-- Toggle Switch -->
                            <div class="relative w-14 h-7 ${plugin.enabled ? 'bg-green-500' : 'bg-gray-300'} peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:bg-green-500 transition-colors duration-200 ease-in-out shadow-inner">
                                <div class="absolute top-[3px] left-[3px] bg-white ${plugin.enabled ? 'translate-x-full' : ''} border-2 ${plugin.enabled ? 'border-green-500' : 'border-gray-400'} rounded-full h-5 w-5 transition-all duration-200 ease-in-out shadow-sm flex items-center justify-center">
                                    ${plugin.enabled ? '<i class="fas fa-check text-green-600 text-xs"></i>' : '<i class="fas fa-times text-gray-400 text-xs"></i>'}
                                </div>
                            </div>
                            <!-- Label with Icon -->
                            <span class="text-sm font-semibold ${plugin.enabled ? 'text-green-700' : 'text-gray-600'} flex items-center gap-1.5" id="toggle-label-${plugin.id}">
                                ${plugin.enabled ? '<i class="fas fa-toggle-on text-green-600"></i>' : '<i class="fas fa-toggle-off text-gray-400"></i>'}
                                <span>${plugin.enabled ? 'Enabled' : 'Disabled'}</span>
                            </span>
                        </div>
                    </label>
                </div>
            </div>

            <!-- Plugin Tags -->
            ${plugin.tags && plugin.tags.length > 0 ? `
                <div class="flex flex-wrap gap-1.5 mb-4">
                    ${plugin.tags.map(tag => `<span class="badge badge-info">${escapeHtml(tag)}</span>`).join('')}
                </div>
            ` : ''}

            <!-- Plugin Actions -->
            <div class="flex flex-wrap gap-2 mt-4 pt-4 border-t border-gray-200">
                <button onclick="configurePlugin('${plugin.id}')"
                        class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm flex-1 font-semibold">
                    <i class="fas fa-cog mr-2"></i>Configure
                </button>
                <button onclick="openOnDemandModal('${plugin.id}')"
                        class="btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm flex-1 font-semibold ${plugin.enabled ? '' : 'opacity-60 cursor-not-allowed'}"
                        ${plugin.enabled ? '' : 'disabled'}>
                    <i class="fas fa-play-circle mr-2"></i>Run On-Demand
                </button>
                <button onclick="updatePlugin('${plugin.id}')"
                        class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm flex-1 font-semibold">
                    <i class="fas fa-sync mr-2"></i>Update
                </button>
                <button onclick="uninstallPlugin('${plugin.id}')"
                        class="btn bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-md text-sm flex-1 font-semibold">
                    <i class="fas fa-trash mr-2"></i>Uninstall
                </button>
            </div>
        </div>
    `).join('');
}

function findInstalledPlugin(pluginId) {
    if (!installedPlugins || installedPlugins.length === 0) {
        return undefined;
    }
    return installedPlugins.find(plugin => plugin.id === pluginId);
}

function resolvePluginDisplayName(pluginId) {
    const plugin = findInstalledPlugin(pluginId);
    if (!plugin) {
        return pluginId;
    }
    return plugin.name || pluginId;
}

function formatSeconds(seconds) {
    if (seconds === undefined || seconds === null) {
        return '';
    }
    const total = Math.max(0, Math.round(seconds));
    const minutes = Math.floor(total / 60);
    const remainingSeconds = total % 60;
    if (minutes > 0) {
        return `${minutes}m${remainingSeconds > 0 ? ` ${remainingSeconds}s` : ''}`;
    }
    return `${remainingSeconds}s`;
}

function updateOnDemandStatusCard(data) {
    const statusEl = document.getElementById('on-demand-status-text');
    const hintEl = document.getElementById('on-demand-service-hint');
    const stopBtn = document.getElementById('stop-on-demand-btn');
    if (!statusEl || !hintEl || !stopBtn) {
        return;
    }

    const state = data?.state || {};
    const service = data?.service || {};
    const status = state.status || (state.active ? 'active' : 'idle');
    const pluginName = state.plugin_id ? resolvePluginDisplayName(state.plugin_id) : '';

    statusEl.classList.remove('text-blue-700', 'text-green-700', 'text-red-700');

    if (status === 'error') {
        statusEl.classList.add('text-red-700');
        statusEl.textContent = state.error ? `On-demand error: ${state.error}` : 'On-demand encountered an error.';
        stopBtn.classList.remove('hidden');
    } else if (state.active) {
        statusEl.classList.add('text-green-700');
        const modeLabel = state.mode ? ` (${state.mode})` : '';
        const remaining = formatSeconds(state.remaining);
        const duration = state.duration ? formatSeconds(state.duration) : null;
        let message = `${pluginName}${modeLabel} is running on-demand`;
        if (remaining) {
            message += ` — ${remaining} remaining`;
        } else if (duration) {
            message += ` — duration ${duration}`;
        } else {
            message += ' — until stopped';
        }
        statusEl.textContent = message;
        stopBtn.classList.remove('hidden');
    } else {
        statusEl.classList.add('text-blue-700');
        const lastEvent = state.last_event ? state.last_event.replace(/-/g, ' ') : null;
        statusEl.textContent = lastEvent && lastEvent !== 'cleared'
            ? `No on-demand session active (last event: ${lastEvent})`
            : 'No on-demand session active.';
        stopBtn.classList.add('hidden');
    }

    if (service.active) {
        hintEl.textContent = 'Display service is running.';
        hintEl.classList.remove('text-red-600');
        hintEl.classList.add('text-blue-600');
    } else {
        const serviceError = service.stderr || service.error;
        hintEl.textContent = serviceError ? `Display service inactive (${serviceError})` : 'Display service is not running.';
        hintEl.classList.remove('text-blue-600');
        hintEl.classList.add('text-red-600');
    }
}

function loadOnDemandStatus(fromRefreshButton = false) {
    fetch('/api/v3/display/on-demand/status')
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                updateOnDemandStatusCard(result.data);
                if (fromRefreshButton && typeof showNotification === 'function') {
                    showNotification('On-demand status refreshed', 'success');
                }
            } else {
                if (typeof showNotification === 'function') {
                    showNotification(result.message || 'Failed to load on-demand status', 'error');
                }
            }
        })
        .catch(error => {
            console.error('Error fetching on-demand status:', error);
            if (typeof showNotification === 'function') {
                showNotification('Error fetching on-demand status: ' + error.message, 'error');
            }
        });
}

function startOnDemandStatusPolling() {
    if (onDemandStatusInterval) {
        clearInterval(onDemandStatusInterval);
    }
    onDemandStatusInterval = setInterval(() => loadOnDemandStatus(false), 15000);
}

window.openOnDemandModal = function(pluginId) {
    const plugin = findInstalledPlugin(pluginId);
    if (!plugin) {
        if (typeof showNotification === 'function') {
            showNotification(`Plugin ${pluginId} not found`, 'error');
        }
        return;
    }

    if (!plugin.enabled) {
        if (typeof showNotification === 'function') {
            showNotification('Enable the plugin before running it on-demand.', 'error');
        }
        return;
    }

    currentOnDemandPluginId = pluginId;

    const modal = document.getElementById('on-demand-modal');
    const modeSelect = document.getElementById('on-demand-mode');
    const modeHint = document.getElementById('on-demand-mode-hint');
    const durationInput = document.getElementById('on-demand-duration');
    const pinnedCheckbox = document.getElementById('on-demand-pinned');
    const startServiceCheckbox = document.getElementById('on-demand-start-service');
    const modalTitle = document.getElementById('on-demand-modal-title');

    if (!modal || !modeSelect || !modeHint || !durationInput || !pinnedCheckbox || !startServiceCheckbox || !modalTitle) {
        console.error('On-demand modal elements not found');
        return;
    }

    modalTitle.textContent = `Run ${resolvePluginDisplayName(pluginId)} On-Demand`;
    modeSelect.innerHTML = '';

    const displayModes = Array.isArray(plugin.display_modes) && plugin.display_modes.length > 0
        ? plugin.display_modes
        : [pluginId];

    displayModes.forEach(mode => {
        const option = document.createElement('option');
        option.value = mode;
        option.textContent = mode;
        modeSelect.appendChild(option);
    });

    if (displayModes.length > 1) {
        modeHint.textContent = 'Select the display mode to show on the matrix.';
    } else {
        modeHint.textContent = 'This plugin exposes a single display mode.';
    }

    durationInput.value = '';
    pinnedCheckbox.checked = false;
    startServiceCheckbox.checked = true;

    // Check service status and show warning if needed
    fetch('/api/v3/display/on-demand/status')
        .then(response => response.json())
        .then(data => {
            const serviceWarning = document.getElementById('on-demand-service-warning');
            const serviceActive = data?.data?.service?.active || false;
            
            if (serviceWarning) {
                if (!serviceActive) {
                    serviceWarning.classList.remove('hidden');
                    // Auto-check the start service checkbox
                    startServiceCheckbox.checked = true;
                } else {
                    serviceWarning.classList.add('hidden');
                }
            }
        })
        .catch(error => {
            console.error('Error checking service status:', error);
        });

    modal.style.display = 'flex';
};

function closeOnDemandModal() {
    const modal = document.getElementById('on-demand-modal');
    if (modal) {
        modal.style.display = 'none';
    }
    currentOnDemandPluginId = null;
}

function submitOnDemandRequest(event) {
    event.preventDefault();
    if (!currentOnDemandPluginId) {
        if (typeof showNotification === 'function') {
            showNotification('Select a plugin before starting on-demand mode.', 'error');
        }
        return;
    }

    const form = document.getElementById('on-demand-form');
    if (!form) {
        return;
    }

    const formData = new FormData(form);
    const mode = formData.get('mode');
    const pinned = formData.get('pinned') === 'on';
    const startService = formData.get('start_service') === 'on';
    const durationValue = formData.get('duration');

    const payload = {
        plugin_id: currentOnDemandPluginId,
        mode,
        pinned,
        start_service: startService
    };

    if (durationValue !== null && durationValue !== '') {
        const parsedDuration = parseInt(durationValue, 10);
        if (!Number.isNaN(parsedDuration) && parsedDuration >= 0) {
            payload.duration = parsedDuration;
        }
    }

    fetch('/api/v3/display/on-demand/start', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
    })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                if (typeof showNotification === 'function') {
                    const pluginName = resolvePluginDisplayName(currentOnDemandPluginId);
                    showNotification(`Requested on-demand mode for ${pluginName}`, 'success');
                }
                closeOnDemandModal();
                setTimeout(() => loadOnDemandStatus(true), 700);
            } else {
                if (typeof showNotification === 'function') {
                    showNotification(result.message || 'Failed to start on-demand mode', 'error');
                }
            }
        })
        .catch(error => {
            console.error('Error starting on-demand mode:', error);
            if (typeof showNotification === 'function') {
                showNotification('Error starting on-demand mode: ' + error.message, 'error');
            }
        });
}

function stopOnDemand(event) {
    const stopBtn = document.getElementById('stop-on-demand-btn');
    const stopService = event && event.shiftKey;
    if (stopBtn) {
        stopBtn.disabled = true;
    }
    fetch('/api/v3/display/on-demand/stop', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            stop_service: stopService
        })
    })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                if (typeof showNotification === 'function') {
                    const message = stopService
                        ? 'On-demand mode stop requested and display service will be stopped.'
                        : 'On-demand mode stop requested';
                    showNotification(message, 'success');
                }
                setTimeout(() => loadOnDemandStatus(true), 700);
            } else {
                if (typeof showNotification === 'function') {
                    showNotification(result.message || 'Failed to stop on-demand mode', 'error');
                }
            }
        })
        .catch(error => {
            console.error('Error stopping on-demand mode:', error);
            if (typeof showNotification === 'function') {
                showNotification('Error stopping on-demand mode: ' + error.message, 'error');
            }
        })
        .finally(() => {
            if (stopBtn) {
                stopBtn.disabled = false;
            }
        });
}

function closeOnDemandModalOnBackdrop(event) {
    if (event.target === event.currentTarget) {
        closeOnDemandModal();
    }
}

window.configurePlugin = function(pluginId) {
    console.log('[DEBUG] ===== configurePlugin called =====');
    console.log('[DEBUG] Plugin ID:', pluginId);
    
    // Navigate to the plugin's configuration tab
    if (window.Alpine && document.querySelector('[x-data="app()"]')) {
        const appElement = document.querySelector('[x-data="app()"]');
        if (appElement && appElement._x_dataStack && appElement._x_dataStack[0]) {
            const appData = appElement._x_dataStack[0];
            appData.activeTab = pluginId;
            console.log('[DEBUG] Switched to plugin tab:', pluginId);
            
            // Show a notification to confirm navigation
            if (appData.showNotification) {
                const plugin = window.installedPlugins?.find(p => p.id === pluginId);
                const pluginName = plugin ? (plugin.name || pluginId) : pluginId;
                appData.showNotification(`Opening ${pluginName} configuration`, 'info');
            }
        } else {
            console.error('[DEBUG] Could not access Alpine app data');
            showNotification('Unable to navigate to plugin configuration. Please refresh the page.', 'error');
        }
    } else {
        console.error('[DEBUG] Alpine.js not available or app element not found');
        showNotification('Unable to navigate to plugin configuration. Please refresh the page.', 'error');
    }
}

function showPluginConfigModal(pluginId, config) {
    const modal = document.getElementById('plugin-config-modal');
    const title = document.getElementById('plugin-config-title');
    const content = document.getElementById('plugin-config-content');

    console.log('[DEBUG] ===== Opening plugin config modal =====');
    console.log('[DEBUG] Plugin ID:', pluginId);
    console.log('[DEBUG] Config:', config);
    
    // Check if modal elements exist
    if (!modal) {
        console.error('[DEBUG] Plugin config modal element not found');
        showError('Plugin configuration modal not found. Please refresh the page.');
        return;
    }
    
    if (!title) {
        console.error('[DEBUG] Plugin config title element not found');
        showError('Plugin configuration title element not found.');
        return;
    }
    
    if (!content) {
        console.error('[DEBUG] Plugin config content element not found');
        showError('Plugin configuration content element not found.');
        return;
    }
    
    title.textContent = `Configure ${pluginId}`;
    
    // Show loading state while form is generated
    content.innerHTML = '<div class="flex items-center justify-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i></div>';
    
    // Show modal immediately
    modal.style.display = 'flex';
    console.log('[DEBUG] Modal display set to flex');
    
    // Generate form asynchronously
    generatePluginConfigForm(pluginId, config)
        .then(formHtml => {
            console.log('[DEBUG] Form generated, setting content. HTML length:', formHtml.length);
            content.innerHTML = formHtml;
            
            // Attach form submit handler after form is inserted
            const form = document.getElementById('plugin-config-form');
            if (form) {
                form.addEventListener('submit', handlePluginConfigSubmit);
                console.log('Form submit handler attached');
            }
        })
        .catch(error => {
            console.error('Error generating config form:', error);
            content.innerHTML = '<p class="text-red-600">Error loading configuration form</p>';
        });
}

// Helper function to get the full property object from schema
function getSchemaProperty(schema, path) {
    if (!schema || !schema.properties) return null;
    
    const parts = path.split('.');
    let current = schema.properties;
    
    for (let i = 0; i < parts.length; i++) {
        const part = parts[i];
        if (current && current[part]) {
            if (i === parts.length - 1) {
                // Last part - return the property
                return current[part];
            } else if (current[part].properties) {
                // Navigate into nested object
                current = current[part].properties;
            } else {
                return null;
            }
        } else {
            return null;
        }
    }
    
    return null;
}

// Helper function to find property type in nested schema using dot notation
function getSchemaPropertyType(schema, path) {
    const prop = getSchemaProperty(schema, path);
    return prop; // Return the full property object (was returning just type, but callers expect object)
}

// Helper function to convert dot notation to nested object
function dotToNested(obj) {
    const result = {};
    
    for (const key in obj) {
        const parts = key.split('.');
        let current = result;
        
        for (let i = 0; i < parts.length - 1; i++) {
            if (!current[parts[i]]) {
                current[parts[i]] = {};
            }
            current = current[parts[i]];
        }
        
        current[parts[parts.length - 1]] = obj[key];
    }
    
    return result;
}

// Helper function to collect all boolean fields from schema (including nested)
function collectBooleanFields(schema, prefix = '') {
    const boolFields = [];
    
    if (!schema || !schema.properties) return boolFields;
    
    Object.entries(schema.properties).forEach(([key, prop]) => {
        const fullKey = prefix ? `${prefix}.${key}` : key;
        
        if (prop.type === 'boolean') {
            boolFields.push(fullKey);
        } else if (prop.type === 'object' && prop.properties) {
            boolFields.push(...collectBooleanFields(prop, fullKey));
        }
    });
    
    return boolFields;
}

function handlePluginConfigSubmit(e) {
    e.preventDefault();
    console.log('Form submitted');
    
    if (!currentPluginConfig) {
        showNotification('Plugin configuration not loaded', 'error');
        return;
    }
    
    const pluginId = currentPluginConfig.pluginId;
    const schema = currentPluginConfig.schema;
    const form = e.target;
    const formData = new FormData(form);
    const flatConfig = {};
    
    console.log('Schema loaded:', schema ? 'Yes' : 'No');
    
    // Process form data with type conversion (using dot notation for nested fields)
    for (const [key, value] of formData.entries()) {
        const propSchema = getSchemaPropertyType(schema, key);
        
        if (propSchema) {
            const propType = propSchema.type;
            
            if (propType === 'array') {
                // Check if this is a file upload widget (JSON array)
                if (propSchema['x-widget'] === 'file-upload') {
                    // Try to parse as JSON first (for file uploads)
                    try {
                        const jsonValue = JSON.parse(value);
                        if (Array.isArray(jsonValue)) {
                            flatConfig[key] = jsonValue;
                            console.log(`File upload array field ${key}: parsed JSON array with ${jsonValue.length} items`);
                        } else {
                            // Fallback to comma-separated
                            const arrayValue = value ? value.split(',').map(v => v.trim()).filter(v => v) : [];
                            flatConfig[key] = arrayValue;
                        }
                    } catch (e) {
                        // Not JSON, use comma-separated
                const arrayValue = value ? value.split(',').map(v => v.trim()).filter(v => v) : [];
                flatConfig[key] = arrayValue;
                console.log(`Array field ${key}: "${value}" -> `, arrayValue);
                    }
                } else {
                    // Regular array: convert comma-separated string to array
                    const arrayValue = value ? value.split(',').map(v => v.trim()).filter(v => v) : [];
                    flatConfig[key] = arrayValue;
                    console.log(`Array field ${key}: "${value}" -> `, arrayValue);
                }
            } else if (propType === 'integer') {
                flatConfig[key] = parseInt(value, 10);
            } else if (propType === 'number') {
                flatConfig[key] = parseFloat(value);
            } else if (propType === 'boolean') {
                flatConfig[key] = form.elements[key].checked;
            } else {
                flatConfig[key] = value;
            }
        } else {
            // No schema, try to infer type
            if (form.elements[key] && form.elements[key].type === 'checkbox') {
                flatConfig[key] = form.elements[key].checked;
            } else {
                flatConfig[key] = value;
            }
        }
    }
    
    // Handle unchecked checkboxes (not in FormData) - including nested ones
    if (schema && schema.properties) {
        const allBoolFields = collectBooleanFields(schema);
        allBoolFields.forEach(key => {
            if (!(key in flatConfig)) {
                flatConfig[key] = false;
            }
        });
    }
    
    // Convert dot notation to nested object
    const config = dotToNested(flatConfig);
    
    console.log('Flat config:', flatConfig);
    console.log('Nested config to save:', config);
    
    // Save the configuration
    fetch('/api/v3/plugins/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            plugin_id: pluginId,
            config: config
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Configuration saved successfully', 'success');
            closePluginConfigModal();
            loadInstalledPlugins(); // Refresh to show updated config
        } else {
            showNotification('Error saving configuration: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving plugin config:', error);
        showNotification('Error saving configuration: ' + error.message, 'error');
    });
}

function generatePluginConfigForm(pluginId, config) {
    console.log('[DEBUG] ===== Generating plugin config form =====');
    console.log('[DEBUG] Plugin ID:', pluginId);
    // Load plugin schema for dynamic form generation
    return fetch(`/api/v3/plugins/schema?plugin_id=${pluginId}`)
        .then(response => response.json())
        .then(schemaData => {
            console.log('[DEBUG] Schema data received:', schemaData.status);
            if (schemaData.status === 'success' && schemaData.data.schema) {
                console.log('[DEBUG] Schema has properties:', Object.keys(schemaData.data.schema.properties || {}));
                // Store plugin ID and schema for form submission
                currentPluginConfig = {
                    pluginId: pluginId,
                    schema: schemaData.data.schema
                };
                console.log('[DEBUG] Calling generateFormFromSchema...');
                return generateFormFromSchema(schemaData.data.schema, config);
            } else {
                // Fallback to simple form if no schema
                currentPluginConfig = { pluginId: pluginId, schema: null };
                return generateSimpleConfigForm(config);
            }
        })
        .catch(error => {
            console.error('Error loading schema:', error);
            currentPluginConfig = { pluginId: pluginId, schema: null };
            return generateSimpleConfigForm(config);
        });
}

// Helper to flatten nested config for form display (converts {nfl: {enabled: true}} to {'nfl.enabled': true})
function flattenConfig(obj, prefix = '') {
    let result = {};
    
    for (const key in obj) {
        const value = obj[key];
        const fullKey = prefix ? `${prefix}.${key}` : key;
        
        if (value !== null && typeof value === 'object' && !Array.isArray(value)) {
            // Recursively flatten nested objects
            Object.assign(result, flattenConfig(value, fullKey));
        } else {
            result[fullKey] = value;
        }
    }
    
    return result;
}

// Generate field HTML for a single property (used recursively)
function generateFieldHtml(key, prop, value, prefix = '') {
    const fullKey = prefix ? `${prefix}.${key}` : key;
    const label = prop.title || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    const description = prop.description || '';
    let html = '';

    // Handle nested objects
    if (prop.type === 'object' && prop.properties) {
        const sectionId = `section-${fullKey.replace(/\./g, '-')}`;
        const nestedConfig = value || {};
        const sectionLabel = prop.title || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        
        html += `
            <div class="nested-section border border-gray-300 rounded-lg overflow-hidden mb-4">
                <button type="button" 
                        class="w-full bg-gray-100 hover:bg-gray-200 px-4 py-3 flex items-center justify-between text-left transition-colors"
                        onclick="toggleNestedSection('${sectionId}')">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-900">${sectionLabel}</h4>
                        ${description ? `<p class="text-sm text-gray-600 mt-1">${description}</p>` : ''}
                    </div>
                    <i id="${sectionId}-icon" class="fas fa-chevron-down text-gray-500 transition-transform"></i>
                </button>
                <div id="${sectionId}" class="nested-content bg-gray-50 px-4 py-3 space-y-3" style="display: block;">
        `;
        
        // Recursively generate fields for nested properties
        Object.entries(prop.properties).forEach(([nestedKey, nestedProp]) => {
            const nestedValue = nestedConfig[nestedKey] !== undefined ? nestedConfig[nestedKey] : nestedProp.default;
            console.log(`[DEBUG] Processing nested field ${fullKey}.${nestedKey}:`, {
                type: nestedProp.type,
                hasXWidget: nestedProp.hasOwnProperty('x-widget'),
                xWidget: nestedProp['x-widget'],
                allKeys: Object.keys(nestedProp)
            });
            html += generateFieldHtml(nestedKey, nestedProp, nestedValue, fullKey);
        });
        
        html += `
                </div>
            </div>
        `;
        
        return html;
    }

    // Regular (non-nested) field
    html += `
        <div class="form-group">
            <label for="${fullKey}" class="block text-sm font-medium text-gray-700 mb-1">
                ${label}
            </label>
    `;

    if (description) {
        html += `<p class="text-sm text-gray-600 mb-2">${description}</p>`;
    }

    // Generate appropriate input based on type
    if (prop.type === 'boolean') {
        html += `
            <label class="flex items-center">
                <input type="checkbox" id="${fullKey}" name="${fullKey}" ${value ? 'checked' : ''} class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <span class="ml-2 text-sm">Enabled</span>
            </label>
        `;
    } else if (prop.type === 'number' || prop.type === 'integer') {
        const min = prop.minimum !== undefined ? `min="${prop.minimum}"` : '';
        const max = prop.maximum !== undefined ? `max="${prop.maximum}"` : '';
        const step = prop.type === 'integer' ? 'step="1"' : 'step="any"';
        html += `
            <input type="number" id="${fullKey}" name="${fullKey}" value="${value !== undefined ? value : ''}" ${min} ${max} ${step} class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
        `;
    } else if (prop.type === 'array') {
        // Check if this is a file upload widget - try multiple ways to access x-widget
        const hasXWidget = prop.hasOwnProperty('x-widget');
        const xWidgetValue = prop['x-widget'];
        const xWidgetValue2 = prop['x-widget'] || prop['x_widget'] || prop.xWidget;
        
        console.log(`[DEBUG] Array field ${fullKey}:`, {
            type: prop.type,
            hasXWidget: hasXWidget,
            'x-widget': xWidgetValue,
            'x-widget (alt)': xWidgetValue2,
            'x-upload-config': prop['x-upload-config'],
            propKeys: Object.keys(prop),
            propString: JSON.stringify(prop),
            value: value
        });
        
        // Check for file-upload widget - be more defensive
        if (xWidgetValue === 'file-upload' || xWidgetValue2 === 'file-upload') {
            console.log(`[DEBUG] ✅ Detected file-upload widget for ${fullKey} - rendering upload zone`);
            const uploadConfig = prop['x-upload-config'] || {};
            const pluginId = uploadConfig.plugin_id || currentPluginConfig?.pluginId || 'static-image';
            const maxFiles = uploadConfig.max_files || 10;
            const allowedTypes = uploadConfig.allowed_types || ['image/png', 'image/jpeg', 'image/bmp', 'image/gif'];
            const maxSizeMB = uploadConfig.max_size_mb || 5;
            
            const currentImages = Array.isArray(value) ? value : [];
            const fieldId = fullKey.replace(/\./g, '_');
            
            html += `
                <div id="${fieldId}_upload_widget" class="mt-1">
                    <!-- File Upload Drop Zone -->
                    <div id="${fieldId}_drop_zone" 
                         class="border-2 border-dashed border-gray-300 rounded-lg p-6 text-center hover:border-blue-400 transition-colors cursor-pointer"
                         ondrop="handleFileDrop(event, '${fieldId}')" 
                         ondragover="event.preventDefault()" 
                         onclick="document.getElementById('${fieldId}_file_input').click()">
                        <input type="file" 
                               id="${fieldId}_file_input" 
                               multiple 
                               accept="${allowedTypes.join(',')}"
                               style="display: none;"
                               onchange="handleFileSelect(event, '${fieldId}')">
                        <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
                        <p class="text-sm text-gray-600">Drag and drop images here or click to browse</p>
                        <p class="text-xs text-gray-500 mt-1">Max ${maxFiles} files, ${maxSizeMB}MB each (PNG, JPG, GIF, BMP)</p>
                    </div>
                    
                    <!-- Uploaded Images List -->
                    <div id="${fieldId}_image_list" class="mt-4 space-y-2">
                        ${currentImages.map((img, idx) => {
                            const imgSchedule = img.schedule || {};
                            const hasSchedule = imgSchedule.enabled && imgSchedule.mode && imgSchedule.mode !== 'always';
                            const scheduleSummary = hasSchedule ? getScheduleSummary(imgSchedule) : 'Always shown';
                            
                            return `
                            <div id="img_${img.id || idx}" class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                                <div class="flex items-center justify-between mb-2">
                                    <div class="flex items-center space-x-3 flex-1">
                                        <img src="/${img.path || ''}" 
                                             alt="${img.filename || ''}" 
                                             class="w-16 h-16 object-cover rounded"
                                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                                        <div style="display:none;" class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center">
                                            <i class="fas fa-image text-gray-400"></i>
                                        </div>
                                        <div class="flex-1 min-w-0">
                                            <p class="text-sm font-medium text-gray-900 truncate">${img.original_filename || img.filename || 'Image'}</p>
                                            <p class="text-xs text-gray-500">${formatFileSize(img.size || 0)} • ${formatDate(img.uploaded_at)}</p>
                                            <p class="text-xs text-blue-600 mt-1">
                                                <i class="fas fa-clock mr-1"></i>${scheduleSummary}
                                            </p>
                                        </div>
                                    </div>
                                    <div class="flex items-center space-x-2 ml-4">
                                        <button type="button" 
                                                onclick="openImageSchedule('${fieldId}', '${img.id}', ${idx})"
                                                class="text-blue-600 hover:text-blue-800 p-2" 
                                                title="Schedule this image">
                                            <i class="fas fa-calendar-alt"></i>
                                        </button>
                                        <button type="button" 
                                                onclick="deleteUploadedImage('${fieldId}', '${img.id}', '${pluginId}')"
                                                class="text-red-600 hover:text-red-800 p-2"
                                                title="Delete image">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <!-- Schedule widget will be inserted here when opened -->
                                <div id="schedule_${img.id || idx}" class="hidden mt-3 pt-3 border-t border-gray-300"></div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                    
                    <!-- Hidden input to store image data -->
                    <input type="hidden" id="${fieldId}_images_data" name="${fullKey}" value="${JSON.stringify(currentImages).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/'/g, '&#39;')}">
                </div>
            `;
        } else {
            // Regular array input
            console.log(`[DEBUG] ❌ NOT a file upload widget for ${fullKey}, using regular array input`);
        const arrayValue = Array.isArray(value) ? value.join(', ') : '';
        html += `
            <input type="text" id="${fullKey}" name="${fullKey}" value="${arrayValue}" placeholder="Enter values separated by commas" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            <p class="text-sm text-gray-600 mt-1">Enter values separated by commas</p>
        `;
        }
    } else if (prop.enum) {
        html += `<select id="${fullKey}" name="${fullKey}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">`;
        prop.enum.forEach(option => {
            const selected = value === option ? 'selected' : '';
            html += `<option value="${option}" ${selected}>${option}</option>`;
        });
        html += `</select>`;
    } else {
        // Check if this is a secret field
        const isSecret = prop['x-secret'] === true;
        const inputType = isSecret ? 'password' : 'text';
        const maxLength = prop.maxLength || '';
        const maxLengthAttr = maxLength ? `maxlength="${maxLength}"` : '';
        const secretClass = isSecret ? 'pr-10' : '';
        
        html += `
            <div class="relative">
                <input type="${inputType}" id="${fullKey}" name="${fullKey}" value="${value !== undefined ? value : ''}" ${maxLengthAttr} class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${secretClass}">
        `;
        
        if (isSecret) {
            html += `
                <button type="button" onclick="togglePasswordVisibility('${fullKey}')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700">
                    <i id="${fullKey}-icon" class="fas fa-eye"></i>
                </button>
            `;
        }
        
        html += `</div>`;
    }

    html += `</div>`;
    
    return html;
}

function generateFormFromSchema(schema, config) {
    console.log('[DEBUG] ===== generateFormFromSchema called =====');
    console.log('[DEBUG] Schema properties:', Object.keys(schema.properties || {}));
    let formHtml = '<form id="plugin-config-form" class="space-y-4">';

    if (schema.properties) {
        Object.entries(schema.properties).forEach(([key, prop]) => {
            // Skip the 'enabled' property - it's managed separately via the header toggle
            if (key === 'enabled') return;

            const value = config[key] !== undefined ? config[key] : prop.default;
            formHtml += generateFieldHtml(key, prop, value);
        });
    }

    formHtml += `
        <div class="flex justify-end space-x-2 pt-4 border-t border-gray-200">
            <button type="button" onclick="closePluginConfigModal()" class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">
                Cancel
            </button>
            <button type="submit" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                <i class="fas fa-save mr-2"></i>Save Configuration
            </button>
        </div>
    </form>
    `;

    return Promise.resolve(formHtml);
}

// Function to toggle nested sections
window.toggleNestedSection = function(sectionId) {
    const content = document.getElementById(sectionId);
    const icon = document.getElementById(sectionId + '-icon');
    
    // Check if content is hidden (handle both explicit 'none' and empty string for initial state)
    const isHidden = content.style.display === 'none';
    
    if (isHidden) {
        // Show the section
        content.style.display = 'block';
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
    } else {
        // Hide the section
        content.style.display = 'none';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    }
}

function generateSimpleConfigForm(config) {
    return `
        <form id="plugin-config-form" class="space-y-4">
            <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-1">Configuration</label>
                <textarea name="config" class="form-control h-32" placeholder="Plugin configuration JSON">${JSON.stringify(config, null, 2)}</textarea>
            </div>

            <div class="flex justify-end space-x-2">
                <button type="button" onclick="closePluginConfigModal()" class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2">
                    Cancel
                </button>
                <button type="submit" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2">
                    Save Configuration
                </button>
            </div>
        </form>
    `;
}

window.closePluginConfigModal = function() {
        const modal = document.getElementById('plugin-config-modal');
    modal.style.display = 'none';
        currentPluginConfig = null;
    console.log('Modal closed');
}

window.togglePlugin = function(pluginId, enabled) {
    const plugin = installedPlugins.find(p => p.id === pluginId);
    const pluginName = plugin ? (plugin.name || pluginId) : pluginId;
    const action = enabled ? 'enabling' : 'disabling';
    
    // Update UI immediately for better UX
    const toggleCheckbox = document.getElementById(`toggle-${pluginId}`);
    const toggleLabel = document.getElementById(`toggle-label-${pluginId}`);
    const wrapperDiv = toggleCheckbox?.parentElement?.querySelector('.flex.items-center.gap-2');
    const toggleTrack = wrapperDiv?.querySelector('.relative.w-14');
    const toggleHandle = toggleTrack?.querySelector('.absolute');
    
    if (toggleCheckbox) toggleCheckbox.checked = enabled;
    
    // Update wrapper background and border
    if (wrapperDiv) {
        if (enabled) {
            wrapperDiv.classList.remove('bg-gray-50', 'border-gray-300');
            wrapperDiv.classList.add('bg-green-50', 'border-green-500');
        } else {
            wrapperDiv.classList.remove('bg-green-50', 'border-green-500');
            wrapperDiv.classList.add('bg-gray-50', 'border-gray-300');
        }
    }
    
    // Update toggle track
    if (toggleTrack) {
        if (enabled) {
            toggleTrack.classList.remove('bg-gray-300');
            toggleTrack.classList.add('bg-green-500');
        } else {
            toggleTrack.classList.remove('bg-green-500');
            toggleTrack.classList.add('bg-gray-300');
        }
    }
    
    // Update toggle handle
    if (toggleHandle) {
        if (enabled) {
            toggleHandle.classList.add('translate-x-full', 'border-green-500');
            toggleHandle.classList.remove('border-gray-400');
            toggleHandle.innerHTML = '<i class="fas fa-check text-green-600 text-xs"></i>';
        } else {
            toggleHandle.classList.remove('translate-x-full', 'border-green-500');
            toggleHandle.classList.add('border-gray-400');
            toggleHandle.innerHTML = '<i class="fas fa-times text-gray-400 text-xs"></i>';
        }
    }
    
    // Update label with icon and text
    if (toggleLabel) {
        if (enabled) {
            toggleLabel.className = 'text-sm font-semibold text-green-700 flex items-center gap-1.5';
            toggleLabel.innerHTML = '<i class="fas fa-toggle-on text-green-600"></i><span>Enabled</span>';
        } else {
            toggleLabel.className = 'text-sm font-semibold text-gray-600 flex items-center gap-1.5';
            toggleLabel.innerHTML = '<i class="fas fa-toggle-off text-gray-400"></i><span>Disabled</span>';
        }
    }
    
    showNotification(`${action.charAt(0).toUpperCase() + action.slice(1)} ${pluginName}...`, 'info');

    fetch('/api/v3/plugins/toggle', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plugin_id: pluginId, enabled: enabled })
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message, data.status);
        if (data.status === 'success') {
            // Update local state
            if (plugin) {
                plugin.enabled = enabled;
            }
            // Refresh the list to ensure consistency
            loadInstalledPlugins();
        } else {
            // Revert the toggle if API call failed
            if (plugin) {
                plugin.enabled = !enabled;
            }
            loadInstalledPlugins();
        }
    })
    .catch(error => {
        showNotification('Error toggling plugin: ' + error.message, 'error');
        // Revert the toggle if API call failed
        if (plugin) {
            plugin.enabled = !enabled;
        }
        loadInstalledPlugins();
    });
}

window.updatePlugin = function(pluginId) {
    showNotification(`Updating ${pluginId}...`, 'info');

    fetch('/api/v3/plugins/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plugin_id: pluginId })
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message, data.status);
        if (data.status === 'success') {
            loadInstalledPlugins(); // Refresh the list
        }
    })
    .catch(error => {
        showNotification('Error updating plugin: ' + error.message, 'error');
    });
}

window.uninstallPlugin = function(pluginId) {
    const plugin = installedPlugins.find(p => p.id === pluginId);
    const pluginName = plugin ? (plugin.name || pluginId) : pluginId;

    if (!confirm(`Are you sure you want to uninstall ${pluginName}?`)) {
        return;
    }

    showNotification(`Uninstalling ${pluginName}...`, 'info');

    fetch('/api/v3/plugins/uninstall', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plugin_id: pluginId })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Uninstall response:', data);
        showNotification(data.message, data.status);
        if (data.status === 'success') {
            // Remove from local array immediately for better UX
            installedPlugins = installedPlugins.filter(p => p.id !== pluginId);
            renderInstalledPlugins(installedPlugins);

            // Also refresh from server to ensure consistency
            setTimeout(() => {
                loadInstalledPlugins();
            }, 1000);
        }
    })
    .catch(error => {
        console.error('Error uninstalling plugin:', error);
        showNotification('Error uninstalling plugin: ' + error.message, 'error');
    });
}

function refreshPlugins() {
    // Clear cache to force fresh data
    pluginStoreCache = null;
    cacheTimestamp = null;
    
    loadInstalledPlugins();
    // Fetch latest metadata from GitHub when refreshing
    searchPluginStore(true);
    showNotification('Plugins refreshed with latest metadata from GitHub', 'success');
}

function restartDisplay() {
    showNotification('Restarting display service...', 'info');
    
    fetch('/api/v3/system/action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'restart_display_service' })
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message, data.status);
    })
    .catch(error => {
        showNotification('Error restarting display: ' + error.message, 'error');
    });
}

function searchPluginStore(fetchLatestVersions = true) {
    console.log('Searching plugin store...', { fetchLatestVersions });
    const query = document.getElementById('plugin-search').value;
    const category = document.getElementById('plugin-category').value;

    // For filtered searches (user typing), we can use cache to avoid excessive API calls
    // For initial load or refresh, always fetch fresh metadata
    const isFilteredSearch = query || category;
    const now = Date.now();
    const isCacheValid = pluginStoreCache && cacheTimestamp && (now - cacheTimestamp < CACHE_DURATION);
    
    // Only use cache for filtered searches that don't explicitly request fresh metadata
    if (isFilteredSearch && isCacheValid && !fetchLatestVersions) {
        console.log('Using cached plugin store data for filtered search');
        // Ensure plugin store grid exists before rendering
        const storeGrid = document.getElementById('plugin-store-grid');
        if (!storeGrid) {
            console.error('plugin-store-grid element not found, cannot render cached plugins');
            // Don't return, let it fetch fresh data
        } else {
            renderPluginStore(pluginStoreCache);
            try {
                const countEl = document.getElementById('store-count');
                if (countEl) {
                    countEl.innerHTML = `${pluginStoreCache.length} available`;
                }
            } catch (e) {
                console.warn('Could not update store count:', e);
            }
            return;
        }
    }

    // Show loading state - safely check element exists
    try {
        const countEl = document.getElementById('store-count');
        if (countEl) {
            countEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Loading...';
        }
    } catch (e) {
        console.warn('Could not update store count:', e);
    }
    showStoreLoading(true);

    let url = '/api/v3/plugins/store/list';
    const params = new URLSearchParams();
    if (query) params.append('query', query);
    if (category) params.append('category', category);
    // Always fetch fresh metadata unless explicitly disabled (for performance on repeated filtered searches)
    if (!fetchLatestVersions) {
        params.append('fetch_latest_versions', 'false');
    }
    // Note: fetch_latest_versions defaults to true on the server side to keep metadata fresh

    if (params.toString()) {
        url += '?' + params.toString();
    }

    console.log('Store URL:', url);

    fetch(url)
        .then(response => {
            console.log('Store response:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Store data:', data);
            showStoreLoading(false);
            
            if (data.status === 'success') {
                const plugins = data.data.plugins || [];
                console.log('Store plugins count:', plugins.length);
                
                // Cache the results if no filters
                if (!query && !category) {
                    pluginStoreCache = plugins;
                    cacheTimestamp = Date.now();
                    console.log('Cached plugin store data');
                }
                
                // Ensure plugin store grid exists before rendering
                const storeGrid = document.getElementById('plugin-store-grid');
                if (!storeGrid) {
                    console.error('plugin-store-grid element not found, cannot render plugins');
                    showError('Plugin store container not found. Please refresh the page.');
                    return;
                }
                
                renderPluginStore(plugins);

                // Update count - safely check element exists
                try {
                    const countEl = document.getElementById('store-count');
                    if (countEl) {
                        countEl.innerHTML = `${plugins.length} available`;
                    }
                } catch (e) {
                    console.warn('Could not update store count:', e);
                }
            } else {
                showError('Failed to search plugin store: ' + data.message);
                try {
                    const countEl = document.getElementById('store-count');
                    if (countEl) {
                        countEl.innerHTML = 'Error loading';
                    }
                } catch (e) {
                    console.warn('Could not update store count:', e);
                }
            }
        })
        .catch(error => {
            console.error('Error searching plugin store:', error);
            showStoreLoading(false);
            showError('Error searching plugin store: ' + error.message);
            try {
                const countEl = document.getElementById('store-count');
                if (countEl) {
                    countEl.innerHTML = 'Error loading';
                }
            } catch (e) {
                console.warn('Could not update store count:', e);
            }
        });
}

function showStoreLoading(show) {
    const loading = document.querySelector('.store-loading');
    if (loading) {
        loading.style.display = show ? 'block' : 'none';
    }
}

function renderPluginStore(plugins) {
    const container = document.getElementById('plugin-store-grid');
    
    if (!container) {
        console.error('plugin-store-grid element not found');
        showError('Plugin store container not found. Please refresh the page.');
        return;
    }

    if (plugins.length === 0) {
        container.innerHTML = `
            <div class="col-span-full empty-state">
                <div class="empty-state-icon">
                    <i class="fas fa-store"></i>
                </div>
                <p class="text-lg font-medium text-gray-700 mb-1">No plugins found</p>
                <p class="text-sm text-gray-500">Try adjusting your search criteria</p>
            </div>
        `;
        return;
    }

    container.innerHTML = plugins.map(plugin => `
        <div class="plugin-card">
            <div class="flex items-start justify-between mb-4">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center flex-wrap gap-2 mb-2">
                        <h4 class="font-semibold text-gray-900 text-base">${escapeHtml(plugin.name || plugin.id)}</h4>
                        ${plugin.verified ? '<span class="badge badge-success"><i class="fas fa-check-circle mr-1"></i>Verified</span>' : ''}
                        ${isNewPlugin(plugin.last_updated) ? '<span class="badge badge-info"><i class="fas fa-sparkles mr-1"></i>New</span>' : ''}
                        ${plugin._source === 'custom_repository' ? `<span class="badge badge-accent" title="From: ${escapeHtml(plugin._repository_name || plugin._repository_url || 'Custom Repository')}"><i class="fas fa-bookmark mr-1"></i>Custom</span>` : ''}
                    </div>
                    <div class="text-sm text-gray-600 space-y-1.5 mb-3">
                        <p class="flex items-center"><i class="fas fa-user mr-2 text-gray-400 w-4"></i>${escapeHtml(plugin.author || 'Unknown')}</p>
                        <p class="flex items-center"><i class="fas fa-code-branch mr-2 text-gray-400 w-4"></i>${formatCommit(plugin.last_commit, plugin.branch)}</p>
                        <p class="flex items-center"><i class="fas fa-calendar mr-2 text-gray-400 w-4"></i>${formatDate(plugin.last_updated)}</p>
                        <p class="flex items-center"><i class="fas fa-tag mr-2 text-gray-400 w-4"></i>${escapeHtml(plugin.category || 'General')}</p>
                        <p class="flex items-center"><i class="fas fa-star mr-2 text-gray-400 w-4"></i>${plugin.stars || 0} stars</p>
                    </div>
                    <p class="text-sm text-gray-700 leading-relaxed">${escapeHtml(plugin.description || 'No description available')}</p>
                </div>
            </div>

            <!-- Plugin Tags -->
            ${plugin.tags && plugin.tags.length > 0 ? `
                <div class="flex flex-wrap gap-1.5 mb-4">
                    ${plugin.tags.map(tag => `<span class="badge badge-info">${escapeHtml(tag)}</span>`).join('')}
                </div>
            ` : ''}

            <!-- Store Actions -->
            <div class="flex gap-2 mt-4 pt-4 border-t border-gray-200">
                <button onclick="installPlugin('${plugin.id}')"
                        class="btn bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm flex-1 font-semibold">
                    <i class="fas fa-download mr-2"></i>Install
                </button>
                <button onclick="window.open('${plugin.repo || '#'}', '_blank')"
                        class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md text-sm flex-1 font-semibold">
                    <i class="fas fa-external-link-alt mr-2"></i>View
                </button>
            </div>
        </div>
    `).join('');
}

// Expose functions to window for onclick handlers
window.installPlugin = function(pluginId) {
    showNotification(`Installing ${pluginId}...`, 'info');

    fetch('/api/v3/plugins/install', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plugin_id: pluginId })
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message, data.status);
        if (data.status === 'success') {
            // Refresh both installed plugins and store
            loadInstalledPlugins();
            // Delay store refresh slightly to ensure DOM is ready
            setTimeout(() => {
                searchPluginStore();
            }, 100);
        }
    })
    .catch(error => {
        showNotification('Error installing plugin: ' + error.message, 'error');
    });
}

function setupCollapsibleSections() {
    // Toggle Installed Plugins section
    const toggleInstalledBtn = document.getElementById('toggle-installed-plugins');
    const installedContent = document.getElementById('installed-plugins-content');
    const installedIcon = document.getElementById('installed-plugins-icon');
    
    if (toggleInstalledBtn && installedContent) {
        toggleInstalledBtn.addEventListener('click', function() {
            const isHidden = installedContent.style.display === 'none' || installedContent.classList.contains('hidden');
            if (isHidden) {
                installedContent.style.display = 'block';
                installedContent.classList.remove('hidden');
                installedIcon.classList.remove('fa-chevron-down');
                installedIcon.classList.add('fa-chevron-up');
                toggleInstalledBtn.querySelector('span').textContent = 'Collapse';
            } else {
                installedContent.style.display = 'none';
                installedContent.classList.add('hidden');
                installedIcon.classList.remove('fa-chevron-up');
                installedIcon.classList.add('fa-chevron-down');
                toggleInstalledBtn.querySelector('span').textContent = 'Expand';
            }
        });
    }
    
    // Toggle Plugin Store section
    const toggleStoreBtn = document.getElementById('toggle-plugin-store');
    const storeContent = document.getElementById('plugin-store-content');
    const storeIcon = document.getElementById('plugin-store-icon');
    
    if (toggleStoreBtn && storeContent) {
        toggleStoreBtn.addEventListener('click', function() {
            const isHidden = storeContent.style.display === 'none' || storeContent.classList.contains('hidden');
            if (isHidden) {
                storeContent.style.display = 'block';
                storeContent.classList.remove('hidden');
                storeIcon.classList.remove('fa-chevron-down');
                storeIcon.classList.add('fa-chevron-up');
                toggleStoreBtn.querySelector('span').textContent = 'Collapse';
            } else {
                storeContent.style.display = 'none';
                storeContent.classList.add('hidden');
                storeIcon.classList.remove('fa-chevron-up');
                storeIcon.classList.add('fa-chevron-down');
                toggleStoreBtn.querySelector('span').textContent = 'Expand';
            }
        });
    }
    
    // Toggle GitHub Token Settings section
    const toggleTokenCollapseBtn = document.getElementById('toggle-github-token-collapse');
    const tokenContent = document.getElementById('github-token-content');
    const tokenIconCollapse = document.getElementById('github-token-icon-collapse');
    
    if (toggleTokenCollapseBtn && tokenContent) {
        toggleTokenCollapseBtn.addEventListener('click', function(e) {
            e.stopPropagation(); // Prevent triggering the close button
            const isHidden = tokenContent.style.display === 'none' || tokenContent.classList.contains('hidden');
            if (isHidden) {
                tokenContent.style.display = 'block';
                tokenContent.classList.remove('hidden');
                tokenIconCollapse.classList.remove('fa-chevron-down');
                tokenIconCollapse.classList.add('fa-chevron-up');
                toggleTokenCollapseBtn.querySelector('span').textContent = 'Collapse';
            } else {
                tokenContent.style.display = 'none';
                tokenContent.classList.add('hidden');
                tokenIconCollapse.classList.remove('fa-chevron-up');
                tokenIconCollapse.classList.add('fa-chevron-down');
                toggleTokenCollapseBtn.querySelector('span').textContent = 'Expand';
            }
        });
    }
}

function loadSavedRepositories() {
    fetch('/api/v3/plugins/saved-repositories')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                renderSavedRepositories(data.data.repositories || []);
            }
        })
        .catch(error => {
            console.error('Error loading saved repositories:', error);
        });
}

function renderSavedRepositories(repositories) {
    const container = document.getElementById('saved-repositories-list');
    const countEl = document.getElementById('saved-repos-count');
    
    if (!container) return;
    
    if (countEl) {
        countEl.textContent = `${repositories.length} saved`;
    }
    
    if (repositories.length === 0) {
        container.innerHTML = '<p class="text-xs text-gray-500 italic">No saved repositories yet. Save a repository URL to see it here.</p>';
        return;
    }
    
    container.innerHTML = repositories.map(repo => {
        const repoUrl = repo.url || '';
        const repoName = repo.name || repoUrl;
        const repoType = repo.type || 'single';
        
        return `
            <div class="bg-white border border-gray-200 rounded p-2 flex items-center justify-between">
                <div class="flex-1 min-w-0">
                    <div class="flex items-center gap-2">
                        <i class="fas ${repoType === 'registry' ? 'fa-folder-open' : 'fa-code-branch'} text-gray-400 text-xs"></i>
                        <span class="text-sm font-medium text-gray-900 truncate" title="${repoUrl}">${escapeHtml(repoName)}</span>
                    </div>
                    <p class="text-xs text-gray-500 truncate" title="${repoUrl}">${escapeHtml(repoUrl)}</p>
                </div>
                <button onclick="removeSavedRepository('${escapeAttr(repoUrl)}')" 
                        class="ml-2 text-red-600 hover:text-red-800 text-xs px-2 py-1" 
                        title="Remove repository">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
    }).join('');
}

window.removeSavedRepository = function(repoUrl) {
    if (!confirm('Remove this saved repository? Its plugins will no longer appear in the store.')) {
        return;
    }
    
    fetch('/api/v3/plugins/saved-repositories', {
        method: 'DELETE',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ repo_url: repoUrl })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccess('Repository removed successfully');
            renderSavedRepositories(data.data.repositories || []);
            // Refresh plugin store to remove plugins from deleted repo
            searchPluginStore();
        } else {
            showError(data.message || 'Failed to remove repository');
        }
    })
    .catch(error => {
        showError('Error removing repository: ' + error.message);
    });
}

function setupGitHubInstallHandlers() {
    // Toggle GitHub install section visibility
    const toggleBtn = document.getElementById('toggle-github-install');
    const installSection = document.getElementById('github-install-section');
    const icon = document.getElementById('github-install-icon');
    
    if (toggleBtn && installSection) {
        toggleBtn.addEventListener('click', function() {
            const isHidden = installSection.classList.contains('hidden');
            if (isHidden) {
                installSection.classList.remove('hidden');
                icon.classList.remove('fa-chevron-down');
                icon.classList.add('fa-chevron-up');
                toggleBtn.querySelector('span').textContent = 'Hide';
            } else {
                installSection.classList.add('hidden');
                icon.classList.remove('fa-chevron-up');
                icon.classList.add('fa-chevron-down');
                toggleBtn.querySelector('span').textContent = 'Show';
            }
        });
    }
    
    // Install single plugin from URL
    const installBtn = document.getElementById('install-plugin-from-url');
    const pluginUrlInput = document.getElementById('github-plugin-url');
    const pluginStatusDiv = document.getElementById('github-plugin-status');
    
    if (installBtn && pluginUrlInput) {
        installBtn.addEventListener('click', function() {
            const repoUrl = pluginUrlInput.value.trim();
            if (!repoUrl) {
                pluginStatusDiv.innerHTML = '<span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>Please enter a GitHub URL</span>';
                return;
            }
            
            if (!repoUrl.includes('github.com')) {
                pluginStatusDiv.innerHTML = '<span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>Please enter a valid GitHub URL</span>';
                return;
            }
            
            installBtn.disabled = true;
            installBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Installing...';
            pluginStatusDiv.innerHTML = '<span class="text-blue-600"><i class="fas fa-spinner fa-spin mr-1"></i>Installing plugin...</span>';
            
            fetch('/api/v3/plugins/install-from-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ repo_url: repoUrl })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    pluginStatusDiv.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Successfully installed: ${data.plugin_id}</span>`;
                    pluginUrlInput.value = '';
                    
                    // Refresh installed plugins list
                    setTimeout(() => {
                        loadInstalledPlugins();
                    }, 1000);
                } else {
                    pluginStatusDiv.innerHTML = `<span class="text-red-600"><i class="fas fa-times-circle mr-1"></i>${data.message || 'Installation failed'}</span>`;
                }
            })
            .catch(error => {
                pluginStatusDiv.innerHTML = `<span class="text-red-600"><i class="fas fa-times-circle mr-1"></i>Error: ${error.message}</span>`;
            })
            .finally(() => {
                installBtn.disabled = false;
                installBtn.innerHTML = '<i class="fas fa-download mr-2"></i>Install';
            });
        });
        
        // Allow Enter key to trigger install
        pluginUrlInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                installBtn.click();
            }
        });
    }
    
    // Load registry from URL
    const loadRegistryBtn = document.getElementById('load-registry-from-url');
    const registryUrlInput = document.getElementById('github-registry-url');
    const registryStatusDiv = document.getElementById('registry-status');
    const customRegistryPlugins = document.getElementById('custom-registry-plugins');
    const customRegistryGrid = document.getElementById('custom-registry-grid');
    
    if (loadRegistryBtn && registryUrlInput) {
        loadRegistryBtn.addEventListener('click', function() {
            const repoUrl = registryUrlInput.value.trim();
            if (!repoUrl) {
                registryStatusDiv.innerHTML = '<span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>Please enter a GitHub URL</span>';
                return;
            }
            
            if (!repoUrl.includes('github.com')) {
                registryStatusDiv.innerHTML = '<span class="text-red-600"><i class="fas fa-exclamation-circle mr-1"></i>Please enter a valid GitHub URL</span>';
                return;
            }
            
            loadRegistryBtn.disabled = true;
            loadRegistryBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Loading...';
            registryStatusDiv.innerHTML = '<span class="text-blue-600"><i class="fas fa-spinner fa-spin mr-1"></i>Loading registry...</span>';
            customRegistryPlugins.classList.add('hidden');
            
            fetch('/api/v3/plugins/registry-from-url', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ repo_url: repoUrl })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success' && data.plugins && data.plugins.length > 0) {
                    registryStatusDiv.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>Found ${data.plugins.length} plugins</span>`;
                    renderCustomRegistryPlugins(data.plugins, repoUrl);
                    customRegistryPlugins.classList.remove('hidden');
                } else {
                    registryStatusDiv.innerHTML = '<span class="text-red-600"><i class="fas fa-times-circle mr-1"></i>No valid registry found or registry is empty</span>';
                    customRegistryPlugins.classList.add('hidden');
                }
            })
            .catch(error => {
                registryStatusDiv.innerHTML = `<span class="text-red-600"><i class="fas fa-times-circle mr-1"></i>Error: ${error.message}</span>`;
                customRegistryPlugins.classList.add('hidden');
            })
            .finally(() => {
                loadRegistryBtn.disabled = false;
                loadRegistryBtn.innerHTML = '<i class="fas fa-search mr-2"></i>Load Registry';
            });
        });
        
        // Allow Enter key to trigger load
        registryUrlInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                loadRegistryBtn.click();
            }
        });
    }
    
    // Save registry URL button
    const saveRegistryBtn = document.getElementById('save-registry-url');
    if (saveRegistryBtn && registryUrlInput) {
        saveRegistryBtn.addEventListener('click', function() {
            const repoUrl = registryUrlInput.value.trim();
            if (!repoUrl) {
                showError('Please enter a repository URL first');
                return;
            }
            
            if (!repoUrl.includes('github.com')) {
                showError('Please enter a valid GitHub URL');
                return;
            }
            
            saveRegistryBtn.disabled = true;
            saveRegistryBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Saving...';
            
            fetch('/api/v3/plugins/saved-repositories', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ repo_url: repoUrl })
            })
            .then(response => response.json())
            .then(data => {
                if (data.status === 'success') {
                    showSuccess('Repository saved successfully! Its plugins will appear in the Plugin Store.');
                    renderSavedRepositories(data.data.repositories || []);
                    // Refresh plugin store to include new repo
                    searchPluginStore();
                } else {
                    showError(data.message || 'Failed to save repository');
                }
            })
            .catch(error => {
                showError('Error saving repository: ' + error.message);
            })
            .finally(() => {
                saveRegistryBtn.disabled = false;
                saveRegistryBtn.innerHTML = '<i class="fas fa-bookmark mr-2"></i>Save Repository';
            });
        });
    }
    
    // Refresh saved repos button
    const refreshSavedReposBtn = document.getElementById('refresh-saved-repos');
    if (refreshSavedReposBtn) {
        refreshSavedReposBtn.addEventListener('click', function() {
            loadSavedRepositories();
            searchPluginStore(); // Also refresh plugin store
            showSuccess('Repositories refreshed');
        });
    }
}

function renderCustomRegistryPlugins(plugins, registryUrl) {
    const container = document.getElementById('custom-registry-grid');
    if (!container) return;
    
    if (plugins.length === 0) {
        container.innerHTML = '<p class="text-sm text-gray-500 col-span-full">No plugins found in this registry</p>';
        return;
    }
    
    // Escape HTML helper
    const escapeHtml = (text) => {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    };
    
    // Escape URL and path for onclick handler
    const escapeAttr = (text) => {
        return (text || '').replace(/'/g, "\\'").replace(/"/g, '&quot;');
    };
    
    container.innerHTML = plugins.map(plugin => {
        const isInstalled = installedPlugins.some(p => p.id === plugin.id);
        const pluginId = escapeAttr(plugin.id);
        const escapedUrl = escapeAttr(registryUrl);
        const pluginPath = escapeAttr(plugin.plugin_path || '');
        
        const installBtn = isInstalled 
            ? '<button class="px-3 py-1 text-xs bg-gray-400 text-white rounded cursor-not-allowed" disabled><i class="fas fa-check mr-1"></i>Installed</button>'
            : `<button onclick="installFromCustomRegistry('${pluginId}', '${escapedUrl}', '${pluginPath}')" class="px-3 py-1 text-xs bg-blue-600 hover:bg-blue-700 text-white rounded"><i class="fas fa-download mr-1"></i>Install</button>`;
        
        return `
            <div class="bg-white border border-gray-200 rounded-lg p-3">
                <div class="flex items-start justify-between mb-2">
                    <div class="flex-1">
                        <h5 class="font-semibold text-sm text-gray-900">${escapeHtml(plugin.name || plugin.id)}</h5>
                        <p class="text-xs text-gray-600 mt-1 line-clamp-2">${escapeHtml(plugin.description || 'No description')}</p>
                    </div>
                </div>
                <div class="flex items-center justify-between mt-2 pt-2 border-t border-gray-100">
                    <span class="text-xs text-gray-500">Last updated ${formatDate(plugin.last_updated)}</span>
                    ${installBtn}
                </div>
            </div>
        `;
    }).join('');
}

window.installFromCustomRegistry = function(pluginId, registryUrl, pluginPath) {
    const repoUrl = registryUrl;
    
    fetch('/api/v3/plugins/install-from-url', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({ 
            repo_url: repoUrl,
            plugin_id: pluginId,
            plugin_path: pluginPath
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showSuccess(`Plugin ${data.plugin_id} installed successfully`);
            // Refresh installed plugins and re-render custom registry
            loadInstalledPlugins();
            // Re-render custom registry to update install buttons
            const registryUrlInput = document.getElementById('github-registry-url');
            if (registryUrlInput && registryUrlInput.value.trim()) {
                document.getElementById('load-registry-from-url').click();
            }
        } else {
            showError(data.message || 'Installation failed');
        }
    })
    .catch(error => {
        showError('Error installing plugin: ' + error.message);
    });
}

function showSuccess(message) {
    // Try to use notification system if available, otherwise use alert
    if (typeof showNotification === 'function') {
        showNotification(message, 'success');
    } else {
        console.log('Success: ' + message);
        // Show a temporary success message
        const statusDiv = document.getElementById('github-plugin-status') || document.getElementById('registry-status');
        if (statusDiv) {
            statusDiv.innerHTML = `<span class="text-green-600"><i class="fas fa-check-circle mr-1"></i>${message}</span>`;
            setTimeout(() => {
                if (statusDiv) statusDiv.innerHTML = '';
            }, 5000);
        }
    }
}

function showError(message) {
    const content = document.getElementById('plugins-content');
    if (!content) {
        console.error('plugins-content element not found');
        if (typeof showNotification === 'function') {
            showNotification(message, 'error');
        } else {
            console.error('Error: ' + message);
        }
        return;
    }
    content.innerHTML = `
        <div class="text-center py-8">
            <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-2"></i>
            <p class="text-red-600">${escapeHtml(message)}</p>
        </div>
    `;
}

// Plugin configuration form submission
document.addEventListener('submit', function(e) {
    if (e.target.id === 'plugin-config-form') {
        e.preventDefault();

        const formData = new FormData(e.target);
        const config = {};
        const schema = currentPluginConfig?.schema;

        // Convert form data to config object
        // Note: 'enabled' is managed separately via the header toggle, not through this form
        for (let [key, value] of formData.entries()) {
            // Skip enabled - it's managed separately via the header toggle
            if (key === 'enabled') continue;

            // Check if this field is an array type in the schema
            if (schema?.properties?.[key]?.type === 'array') {
                // Convert comma-separated string to array
                const arrayValue = value.split(',').map(item => item.trim()).filter(item => item.length > 0);
                config[key] = arrayValue;
                console.log(`Array field ${key}: "${value}" -> `, arrayValue);
            } else if (key === 'display_duration' || schema?.properties?.[key]?.type === 'integer') {
                config[key] = parseInt(value);
            } else if (schema?.properties?.[key]?.type === 'number') {
                config[key] = parseFloat(value);
            } else if (schema?.properties?.[key]?.type === 'boolean') {
                config[key] = value === 'true' || value === true;
            } else {
                config[key] = value;
            }
        }

        console.log('Final config to save:', config);
        console.log('Schema loaded:', schema ? 'Yes' : 'No');

        // Save the configuration
        savePluginConfiguration(currentPluginConfig.pluginId, config);
    }
});

function savePluginConfiguration(pluginId, config) {
    // Update the plugin configuration in the backend
    fetch('/api/v3/plugins/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plugin_id: pluginId, config })
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message, data.status);
        if (data.status === 'success') {
            closePluginConfigModal();
            // Refresh the installed plugins to update the UI
            loadInstalledPlugins();
        }
    })
    .catch(error => {
        showNotification('Error saving plugin configuration: ' + error.message, 'error');
    });
}

// Utility function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Format date for display
function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    
    try {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays < 1) {
            return 'Today';
        } else if (diffDays < 2) {
            return 'Yesterday';
        } else if (diffDays < 7) {
            return `${diffDays} days ago`;
        } else if (diffDays < 30) {
            const weeks = Math.floor(diffDays / 7);
            return `${weeks} ${weeks === 1 ? 'week' : 'weeks'} ago`;
        } else {
            // Return formatted date for older items
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }
    } catch (e) {
        return dateString;
    }
}

function formatCommit(commit, branch) {
    const shortCommit = commit ? String(commit).substring(0, 7) : '';
    const branchText = branch ? String(branch) : '';

    if (branchText && shortCommit) {
        return `${branchText} · ${shortCommit}`;
    }
    if (branchText) {
        return branchText;
    }
    if (shortCommit) {
        return shortCommit;
    }
    return 'Latest';
}

// Check if plugin is new (updated within last 7 days)
function isNewPlugin(lastUpdated) {
    if (!lastUpdated) return false;
    
    try {
        const date = new Date(lastUpdated);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        return diffDays <= 7;
    } catch (e) {
        return false;
    }
}

// Debounce utility
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Toggle password visibility for secret fields
function togglePasswordVisibility(fieldId) {
    const input = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '-icon');
    
    if (input && icon) {
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
}

// GitHub Token Configuration Functions
window.toggleGithubTokenSettings = function() {
    const settings = document.getElementById('github-token-settings');
    if (settings) {
        settings.classList.toggle('hidden');
        if (!settings.classList.contains('hidden')) {
            loadGithubToken();
        }
    }
}

window.toggleGithubTokenVisibility = function() {
    const input = document.getElementById('github-token-input');
    const icon = document.getElementById('github-token-icon');
    
    if (input && icon) {
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
}

window.loadGithubToken = function() {
    fetch('/api/v3/config/secrets')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const token = data.data?.github?.api_token || '';
                const input = document.getElementById('github-token-input');
                if (input) {
                    input.value = token;
                    if (token && token !== 'YOUR_GITHUB_PERSONAL_ACCESS_TOKEN') {
                        showNotification('GitHub token loaded successfully', 'success');
                    } else {
                        showNotification('No GitHub token configured', 'info');
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error loading GitHub token:', error);
            showNotification('Error loading GitHub token', 'error');
        });
}

window.saveGithubToken = function() {
    const input = document.getElementById('github-token-input');
    if (!input) return;
    
    const token = input.value.trim();
    
    if (!token) {
        showNotification('Please enter a GitHub token', 'error');
        return;
    }
    
    // Load current secrets config
    fetch('/api/v3/config/secrets')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const secrets = data.data || {};
                
                // Update GitHub token
                if (!secrets.github) {
                    secrets.github = {};
                }
                secrets.github.api_token = token;
                
                // Save updated secrets
                return fetch('/api/v3/config/raw/secrets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(secrets)
                });
            } else {
                throw new Error('Failed to load current secrets');
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showNotification('GitHub token saved successfully! Rate limit increased to 5,000/hour', 'success');
                // Hide the warning banner
                const warning = document.getElementById('github-auth-warning');
                if (warning) {
                    warning.classList.add('hidden');
                }
                // Hide the settings panel after successful save
                setTimeout(() => {
                    toggleGithubTokenSettings();
                }, 2000);
            } else {
                showNotification('Error saving GitHub token: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error saving GitHub token:', error);
            showNotification('Error saving GitHub token: ' + error.message, 'error');
        });
}

// GitHub Authentication Status
// Only shows the warning banner if no GitHub token is configured
// The token itself is never exposed to the frontend for security
function checkGitHubAuthStatus() {
    fetch('/api/v3/plugins/store/github-status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const authData = data.data;

                // Only show the banner if no GitHub token is configured
                if (!authData.authenticated) {
                    // Check if user has dismissed the warning (stored in session storage)
                    const dismissed = sessionStorage.getItem('github-auth-warning-dismissed');
                    if (!dismissed) {
                        const warning = document.getElementById('github-auth-warning');
                        const rateLimit = document.getElementById('rate-limit-count');

                        if (warning && rateLimit) {
                            rateLimit.textContent = authData.rate_limit;
                            warning.classList.remove('hidden');
                            console.log('GitHub token not configured - showing API limit warning');
                        }
                    }
                } else {
                    // Token is configured - ensure the banner is hidden
                    const warning = document.getElementById('github-auth-warning');
                    if (warning) {
                        warning.classList.add('hidden');
                        console.log('GitHub token is configured - API limit warning hidden');
                    }
                    
                    // Also hide the GitHub token settings panel if it's visible
                    const settings = document.getElementById('github-token-settings');
                    if (settings && !settings.classList.contains('hidden')) {
                        settings.classList.add('hidden');
                        console.log('GitHub token is configured - hiding settings panel');
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error checking GitHub auth status:', error);
        });
}

window.dismissGithubWarning = function() {
    const warning = document.getElementById('github-auth-warning');
    if (warning) {
        warning.classList.add('hidden');
        // Remember dismissal for this session
        sessionStorage.setItem('github-auth-warning-dismissed', 'true');
    }
}

window.showGithubTokenInstructions = function() {
    const instructions = `
        <div class="space-y-4">
            <h4 class="font-semibold text-lg">How to Add a GitHub Token</h4>
            
            <div class="space-y-3">
                <div class="bg-gray-50 p-3 rounded">
                    <h5 class="font-medium mb-2">Step 1: Create a GitHub Token</h5>
                    <ol class="list-decimal list-inside space-y-1 text-sm">
                        <li>Click the "Create a GitHub Token" link above (or <a href="https://github.com/settings/tokens/new?description=LEDMatrix%20Plugin%20Manager&scopes=" target="_blank" class="text-blue-600 underline">click here</a>)</li>
                        <li>Give it a name like "LEDMatrix Plugin Manager"</li>
                        <li>No special scopes/permissions are needed for public repositories</li>
                        <li>Click "Generate token" at the bottom</li>
                        <li>Copy the generated token (it starts with "ghp_")</li>
                    </ol>
                </div>
                
                <div class="bg-gray-50 p-3 rounded">
                    <h5 class="font-medium mb-2">Step 2: Add Token to LEDMatrix</h5>
                    <ol class="list-decimal list-inside space-y-1 text-sm">
                        <li>SSH into your Raspberry Pi</li>
                        <li>Edit the secrets file: <code class="bg-gray-200 px-1 rounded">nano ~/LEDMatrix/config/config_secrets.json</code></li>
                        <li>Find the "github" section and add your token:
                            <pre class="bg-gray-800 text-white p-2 rounded mt-2 text-xs overflow-x-auto">"github": {
  "api_token": "ghp_your_token_here"
}</pre>
                        </li>
                        <li>Save the file (Ctrl+O, Enter, Ctrl+X)</li>
                        <li>Restart the web service: <code class="bg-gray-200 px-1 rounded">sudo systemctl restart ledmatrix-web</code></li>
                    </ol>
                </div>
                
                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Note:</strong> Your token is stored locally and never shared. It's only used to authenticate API requests to GitHub.
                    </p>
                </div>
            </div>
            
            <div class="flex justify-end">
                <button onclick="closeInstructionsModal()" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                    Got it!
                </button>
            </div>
        </div>
    `;
    
    // Use the existing plugin config modal for instructions
    const modal = document.getElementById('plugin-config-modal');
    const title = document.getElementById('plugin-config-title');
    const content = document.getElementById('plugin-config-content');
    
    title.textContent = 'GitHub Token Setup';
    content.innerHTML = instructions;
    modal.style.display = 'flex';
    console.log('GitHub instructions modal opened');
}

window.closeInstructionsModal = function() {
    const modal = document.getElementById('plugin-config-modal');
    modal.style.display = 'none';
    console.log('Instructions modal closed');
}

// ==================== File Upload Functions ====================
// Make these globally accessible for use in base.html

window.handleFileDrop = function(event, fieldId) {
    event.preventDefault();
    const files = event.dataTransfer.files;
    if (files.length > 0) {
        window.handleFiles(fieldId, Array.from(files));
    }
}

window.handleFileSelect = function(event, fieldId) {
    const files = event.target.files;
    if (files.length > 0) {
        window.handleFiles(fieldId, Array.from(files));
    }
}

window.handleFiles = async function(fieldId, files) {
    const uploadConfig = window.getUploadConfig(fieldId);
    const pluginId = uploadConfig.plugin_id || window.currentPluginConfig?.pluginId || 'static-image';
    const maxFiles = uploadConfig.max_files || 10;
    const maxSizeMB = uploadConfig.max_size_mb || 5;
    
    // Validate file count
    const currentImages = window.getCurrentImages(fieldId);
    if (currentImages.length + files.length > maxFiles) {
        showNotification(`Maximum ${maxFiles} files allowed. You have ${currentImages.length} and tried to add ${files.length}.`, 'error');
        return;
    }
    
    // Validate file types and sizes
    const validFiles = [];
    for (const file of files) {
        if (file.size > maxSizeMB * 1024 * 1024) {
            showNotification(`File ${file.name} exceeds ${maxSizeMB}MB limit`, 'error');
            continue;
        }
        
        const allowedTypes = ['image/png', 'image/jpeg', 'image/jpg', 'image/bmp', 'image/gif'];
        if (!allowedTypes.includes(file.type)) {
            showNotification(`File ${file.name} is not a valid image type`, 'error');
            continue;
        }
        
        validFiles.push(file);
    }
    
    if (validFiles.length === 0) {
        return;
    }
    
    // Show upload progress
    window.showUploadProgress(fieldId, validFiles.length);
    
    // Upload files
    const formData = new FormData();
    formData.append('plugin_id', pluginId);
    validFiles.forEach(file => formData.append('files', file));
    
    try {
        const response = await fetch('/api/v3/plugins/assets/upload', {
            method: 'POST',
            body: formData
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // Add uploaded images to current list
            const currentImages = window.getCurrentImages(fieldId);
            const newImages = [...currentImages, ...data.uploaded_files];
            window.updateImageList(fieldId, newImages);
            
            showNotification(`Successfully uploaded ${data.uploaded_files.length} image(s)`, 'success');
        } else {
            showNotification(`Upload failed: ${data.message}`, 'error');
        }
    } catch (error) {
        console.error('Upload error:', error);
        showNotification(`Upload error: ${error.message}`, 'error');
    } finally {
        window.hideUploadProgress(fieldId);
        // Clear file input
        const fileInput = document.getElementById(`${fieldId}_file_input`);
        if (fileInput) {
            fileInput.value = '';
        }
    }
}

window.deleteUploadedImage = async function(fieldId, imageId, pluginId) {
    if (!confirm('Are you sure you want to delete this image?')) {
        return;
    }
    
    try {
        const response = await fetch('/api/v3/plugins/assets/delete', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plugin_id: pluginId, image_id: imageId })
        });
        
        const data = await response.json();
        
        if (data.status === 'success') {
            // Remove from current list
            const currentImages = window.getCurrentImages(fieldId);
            const newImages = currentImages.filter(img => img.id !== imageId);
            window.updateImageList(fieldId, newImages);
            
            showNotification('Image deleted successfully', 'success');
        } else {
            showNotification(`Delete failed: ${data.message}`, 'error');
        }
    } catch (error) {
        console.error('Delete error:', error);
        showNotification(`Delete error: ${error.message}`, 'error');
    }
}

window.getUploadConfig = function(fieldId) {
    // Extract config from schema
    const schema = window.currentPluginConfig?.schema;
    if (!schema || !schema.properties) return {};
    
    // Find the property that matches this fieldId
    // FieldId is like "image_config_images" for "image_config.images"
    const key = fieldId.replace(/_/g, '.');
    const keys = key.split('.');
    let prop = schema.properties;
    
    for (const k of keys) {
        if (prop && prop[k]) {
            prop = prop[k];
            if (prop.properties && prop.type === 'object') {
                prop = prop.properties;
            } else if (prop.type === 'array' && prop['x-widget'] === 'file-upload') {
                break;
            } else {
                break;
            }
        }
    }
    
    // If we found an array with x-widget, get its config
    if (prop && prop.type === 'array' && prop['x-widget'] === 'file-upload') {
        return prop['x-upload-config'] || {};
    }
    
    // Try to find nested images array
    if (schema.properties && schema.properties.image_config && 
        schema.properties.image_config.properties && 
        schema.properties.image_config.properties.images) {
        const imagesProp = schema.properties.image_config.properties.images;
        if (imagesProp['x-widget'] === 'file-upload') {
            return imagesProp['x-upload-config'] || {};
        }
    }
    
    return {};
}

window.getCurrentImages = function(fieldId) {
    const hiddenInput = document.getElementById(`${fieldId}_images_data`);
    if (hiddenInput && hiddenInput.value) {
        try {
            return JSON.parse(hiddenInput.value);
        } catch (e) {
            console.error('Error parsing images data:', e);
        }
    }
    return [];
}

window.updateImageList = function(fieldId, images) {
    const hiddenInput = document.getElementById(`${fieldId}_images_data`);
    if (hiddenInput) {
        hiddenInput.value = JSON.stringify(images);
    }
    
    // Update the display
    const imageList = document.getElementById(`${fieldId}_image_list`);
    if (imageList) {
        const uploadConfig = window.getUploadConfig(fieldId);
        const pluginId = uploadConfig.plugin_id || window.currentPluginConfig?.pluginId || 'static-image';
        
        imageList.innerHTML = images.map((img, idx) => {
            const imgSchedule = img.schedule || {};
            const hasSchedule = imgSchedule.enabled && imgSchedule.mode && imgSchedule.mode !== 'always';
            const scheduleSummary = hasSchedule ? (window.getScheduleSummary ? window.getScheduleSummary(imgSchedule) : 'Scheduled') : 'Always shown';
            
            return `
            <div id="img_${img.id || idx}" class="bg-gray-50 p-3 rounded-lg border border-gray-200">
                <div class="flex items-center justify-between mb-2">
                    <div class="flex items-center space-x-3 flex-1">
                        <img src="/${img.path || ''}" 
                             alt="${img.filename || ''}" 
                             class="w-16 h-16 object-cover rounded"
                             onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                        <div style="display:none;" class="w-16 h-16 bg-gray-200 rounded flex items-center justify-center">
                            <i class="fas fa-image text-gray-400"></i>
                        </div>
                        <div class="flex-1 min-w-0">
                            <p class="text-sm font-medium text-gray-900 truncate">${img.original_filename || img.filename || 'Image'}</p>
                            <p class="text-xs text-gray-500">${window.formatFileSize ? window.formatFileSize(img.size || 0) : (Math.round((img.size || 0) / 1024) + ' KB')} • ${window.formatDate ? window.formatDate(img.uploaded_at) : (img.uploaded_at || '')}</p>
                            <p class="text-xs text-blue-600 mt-1">
                                <i class="fas fa-clock mr-1"></i>${scheduleSummary}
                            </p>
                        </div>
                    </div>
                    <div class="flex items-center space-x-2 ml-4">
                        <button type="button" 
                                onclick="window.openImageSchedule('${fieldId}', '${img.id}', ${idx})"
                                class="text-blue-600 hover:text-blue-800 p-2" 
                                title="Schedule this image">
                            <i class="fas fa-calendar-alt"></i>
                        </button>
                        <button type="button" 
                                onclick="window.deleteUploadedImage('${fieldId}', '${img.id}', '${pluginId}')"
                                class="text-red-600 hover:text-red-800 p-2"
                                title="Delete image">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
                <!-- Schedule widget will be inserted here when opened -->
                <div id="schedule_${img.id || idx}" class="hidden mt-3 pt-3 border-t border-gray-300"></div>
            </div>
            `;
        }).join('');
    }
}

window.showUploadProgress = function(fieldId, totalFiles) {
    const dropZone = document.getElementById(`${fieldId}_drop_zone`);
    if (dropZone) {
        dropZone.innerHTML = `
            <i class="fas fa-spinner fa-spin text-3xl text-blue-500 mb-2"></i>
            <p class="text-sm text-gray-600">Uploading ${totalFiles} file(s)...</p>
        `;
        dropZone.style.pointerEvents = 'none';
    }
}

window.hideUploadProgress = function(fieldId) {
    const uploadConfig = window.getUploadConfig(fieldId);
    const maxFiles = uploadConfig.max_files || 10;
    const maxSizeMB = uploadConfig.max_size_mb || 5;
    const allowedTypes = uploadConfig.allowed_types || ['image/png', 'image/jpeg', 'image/bmp', 'image/gif'];
    
    const dropZone = document.getElementById(`${fieldId}_drop_zone`);
    if (dropZone) {
        dropZone.innerHTML = `
            <i class="fas fa-cloud-upload-alt text-3xl text-gray-400 mb-2"></i>
            <p class="text-sm text-gray-600">Drag and drop images here or click to browse</p>
            <p class="text-xs text-gray-500 mt-1">Max ${maxFiles} files, ${maxSizeMB}MB each (PNG, JPG, GIF, BMP)</p>
        `;
        dropZone.style.pointerEvents = 'auto';
    }
}

window.formatFileSize = function(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
}

function formatDate(dateString) {
    if (!dateString) return 'Unknown date';
    try {
        const date = new Date(dateString);
        return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    } catch (e) {
        return dateString;
    }
}

window.getScheduleSummary = function(schedule) {
    if (!schedule || !schedule.enabled || schedule.mode === 'always') {
        return 'Always shown';
    }
    
    if (schedule.mode === 'time_range') {
        return `${schedule.start_time || '08:00'} - ${schedule.end_time || '18:00'} (daily)`;
    }
    
    if (schedule.mode === 'per_day' && schedule.days) {
        const enabledDays = Object.entries(schedule.days)
            .filter(([day, config]) => config && config.enabled)
            .map(([day]) => day.charAt(0).toUpperCase() + day.slice(1, 3));
        
        if (enabledDays.length === 0) {
            return 'Never shown';
        }
        
        return enabledDays.join(', ') + ' only';
    }
    
    return 'Scheduled';
}

window.openImageSchedule = function(fieldId, imageId, imageIdx) {
    const currentImages = getCurrentImages(fieldId);
    const image = currentImages[imageIdx];
    if (!image) return;
    
    const scheduleContainer = document.getElementById(`schedule_${imageId || imageIdx}`);
    if (!scheduleContainer) return;
    
    // Toggle visibility
    const isVisible = !scheduleContainer.classList.contains('hidden');
    
    if (isVisible) {
        scheduleContainer.classList.add('hidden');
        return;
    }
    
    scheduleContainer.classList.remove('hidden');
    
    const schedule = image.schedule || { enabled: false, mode: 'always', start_time: '08:00', end_time: '18:00', days: {} };
    
    scheduleContainer.innerHTML = `
        <div class="bg-white rounded-lg border border-blue-200 p-4">
            <h4 class="text-sm font-semibold text-gray-900 mb-3">
                <i class="fas fa-clock mr-2"></i>Schedule Settings
            </h4>
            
            <!-- Enable Schedule -->
            <div class="mb-4">
                <label class="flex items-center">
                    <input type="checkbox" 
                           id="schedule_enabled_${imageId}"
                           ${schedule.enabled ? 'checked' : ''}
                           onchange="window.toggleImageScheduleEnabled('${fieldId}', '${imageId}', ${imageIdx})"
                           class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                    <span class="ml-2 text-sm font-medium text-gray-700">Enable schedule for this image</span>
                </label>
                <p class="ml-6 text-xs text-gray-500 mt-1">When enabled, this image will only display during scheduled times</p>
            </div>
            
            <!-- Schedule Mode -->
            <div id="schedule_options_${imageId}" class="space-y-4" style="display: ${schedule.enabled ? 'block' : 'none'};">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Schedule Type</label>
                    <select id="schedule_mode_${imageId}"
                            onchange="window.updateImageScheduleMode('${fieldId}', '${imageId}', ${imageIdx})"
                            class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                        <option value="always" ${schedule.mode === 'always' ? 'selected' : ''}>Always Show (No Schedule)</option>
                        <option value="time_range" ${schedule.mode === 'time_range' ? 'selected' : ''}>Same Time Every Day</option>
                        <option value="per_day" ${schedule.mode === 'per_day' ? 'selected' : ''}>Different Times Per Day</option>
                    </select>
                </div>
                
                <!-- Time Range Mode -->
                <div id="time_range_${imageId}" class="grid grid-cols-2 gap-4" style="display: ${schedule.mode === 'time_range' ? 'grid' : 'none'};">
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">Start Time</label>
                        <input type="time" 
                               id="schedule_start_${imageId}"
                               value="${schedule.start_time || '08:00'}"
                               onchange="window.updateImageScheduleTime('${fieldId}', '${imageId}', ${imageIdx})"
                               class="block w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                    </div>
                    <div>
                        <label class="block text-xs font-medium text-gray-700 mb-1">End Time</label>
                        <input type="time" 
                               id="schedule_end_${imageId}"
                               value="${schedule.end_time || '18:00'}"
                               onchange="window.updateImageScheduleTime('${fieldId}', '${imageId}', ${imageIdx})"
                               class="block w-full px-2 py-1 text-sm border border-gray-300 rounded-md">
                    </div>
                </div>
                
                <!-- Per-Day Mode -->
                <div id="per_day_${imageId}" style="display: ${schedule.mode === 'per_day' ? 'block' : 'none'};">
                    <label class="block text-xs font-medium text-gray-700 mb-2">Day-Specific Times</label>
                    <div class="bg-gray-50 rounded p-3 space-y-2 max-h-64 overflow-y-auto">
                        ${['monday', 'tuesday', 'wednesday', 'thursday', 'friday', 'saturday', 'sunday'].map(day => {
                            const dayConfig = (schedule.days && schedule.days[day]) || { enabled: true, start_time: '08:00', end_time: '18:00' };
                            return `
                            <div class="bg-white rounded p-2 border border-gray-200">
                                <div class="flex items-center justify-between mb-2">
                                    <label class="flex items-center">
                                        <input type="checkbox"
                                               id="day_${day}_${imageId}"
                                               ${dayConfig.enabled ? 'checked' : ''}
                                               onchange="window.updateImageScheduleDay('${fieldId}', '${imageId}', ${imageIdx}, '${day}')"
                                               class="h-3 w-3 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                                        <span class="ml-2 text-xs font-medium text-gray-700 capitalize">${day}</span>
                                    </label>
                                </div>
                                <div class="grid grid-cols-2 gap-2 ml-5" id="day_times_${day}_${imageId}" style="display: ${dayConfig.enabled ? 'grid' : 'none'};">
                                    <input type="time"
                                           id="day_${day}_start_${imageId}"
                                           value="${dayConfig.start_time || '08:00'}"
                                           onchange="updateImageScheduleDay('${fieldId}', '${imageId}', ${imageIdx}, '${day}')"
                                           class="text-xs px-2 py-1 border border-gray-300 rounded"
                                           ${!dayConfig.enabled ? 'disabled' : ''}>
                                    <input type="time"
                                           id="day_${day}_end_${imageId}"
                                           value="${dayConfig.end_time || '18:00'}"
                                           onchange="updateImageScheduleDay('${fieldId}', '${imageId}', ${imageIdx}, '${day}')"
                                           class="text-xs px-2 py-1 border border-gray-300 rounded"
                                           ${!dayConfig.enabled ? 'disabled' : ''}>
                                </div>
                            </div>
                            `;
                        }).join('')}
                    </div>
                </div>
            </div>
        </div>
    `;
}

window.toggleImageScheduleEnabled = function(fieldId, imageId, imageIdx) {
    const currentImages = window.getCurrentImages(fieldId);
    const image = currentImages[imageIdx];
    if (!image) return;
    
    const checkbox = document.getElementById(`schedule_enabled_${imageId}`);
    const enabled = checkbox.checked;
    
    if (!image.schedule) {
        image.schedule = { enabled: false, mode: 'always', start_time: '08:00', end_time: '18:00', days: {} };
    }
    
    image.schedule.enabled = enabled;
    
    const optionsDiv = document.getElementById(`schedule_options_${imageId}`);
    if (optionsDiv) {
        optionsDiv.style.display = enabled ? 'block' : 'none';
    }
    
    window.updateImageList(fieldId, currentImages);
}

window.updateImageScheduleMode = function(fieldId, imageId, imageIdx) {
    const currentImages = window.getCurrentImages(fieldId);
    const image = currentImages[imageIdx];
    if (!image) return;
    
    if (!image.schedule) {
        image.schedule = { enabled: true, mode: 'always', start_time: '08:00', end_time: '18:00', days: {} };
    }
    
    const modeSelect = document.getElementById(`schedule_mode_${imageId}`);
    const mode = modeSelect.value;
    
    image.schedule.mode = mode;
    
    const timeRangeDiv = document.getElementById(`time_range_${imageId}`);
    const perDayDiv = document.getElementById(`per_day_${imageId}`);
    
    if (timeRangeDiv) timeRangeDiv.style.display = mode === 'time_range' ? 'grid' : 'none';
    if (perDayDiv) perDayDiv.style.display = mode === 'per_day' ? 'block' : 'none';
    
    window.updateImageList(fieldId, currentImages);
}

window.updateImageScheduleTime = function(fieldId, imageId, imageIdx) {
    const currentImages = window.getCurrentImages(fieldId);
    const image = currentImages[imageIdx];
    if (!image) return;
    
    if (!image.schedule) {
        image.schedule = { enabled: true, mode: 'time_range', start_time: '08:00', end_time: '18:00' };
    }
    
    const startInput = document.getElementById(`schedule_start_${imageId}`);
    const endInput = document.getElementById(`schedule_end_${imageId}`);
    
    if (startInput) image.schedule.start_time = startInput.value || '08:00';
    if (endInput) image.schedule.end_time = endInput.value || '18:00';
    
    window.updateImageList(fieldId, currentImages);
}

window.updateImageScheduleDay = function(fieldId, imageId, imageIdx, day) {
    const currentImages = window.getCurrentImages(fieldId);
    const image = currentImages[imageIdx];
    if (!image) return;
    
    if (!image.schedule) {
        image.schedule = { enabled: true, mode: 'per_day', days: {} };
    }
    
    if (!image.schedule.days) {
        image.schedule.days = {};
    }
    
    const checkbox = document.getElementById(`day_${day}_${imageId}`);
    const startInput = document.getElementById(`day_${day}_start_${imageId}`);
    const endInput = document.getElementById(`day_${day}_end_${imageId}`);
    
    const enabled = checkbox ? checkbox.checked : true;
    
    if (!image.schedule.days[day]) {
        image.schedule.days[day] = { enabled: true, start_time: '08:00', end_time: '18:00' };
    }
    
    image.schedule.days[day].enabled = enabled;
    
    if (startInput) image.schedule.days[day].start_time = startInput.value || '08:00';
    if (endInput) image.schedule.days[day].end_time = endInput.value || '18:00';
    
    const timesDiv = document.getElementById(`day_times_${day}_${imageId}`);
    if (timesDiv) {
        timesDiv.style.display = enabled ? 'grid' : 'none';
        if (startInput) startInput.disabled = !enabled;
        if (endInput) endInput.disabled = !enabled;
    }
    
    window.updateImageList(fieldId, currentImages);
}

})(); // End IIFE

// Make currentPluginConfig globally accessible (outside IIFE)
window.currentPluginConfig = null;
</script>
