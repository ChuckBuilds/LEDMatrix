<div class="bg-white rounded-lg shadow p-6">
    <div class="border-b border-gray-200 pb-4 mb-6">
        <h2 class="text-lg font-semibold text-gray-900">Plugin Management</h2>
        <p class="mt-1 text-sm text-gray-600">Manage installed plugins, configure settings, and browse the plugin store.</p>
    </div>

    <!-- Plugin Controls -->
    <div class="flex flex-wrap items-center justify-between gap-4 mb-6">
        <div class="flex items-center space-x-4">
            <button id="refresh-plugins-btn" class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">
                <i class="fas fa-sync-alt mr-2"></i>Refresh Plugins
            </button>
            <button id="restart-display-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                <i class="fas fa-redo mr-2"></i>Restart Display
            </button>
        </div>
    </div>

    <!-- Plugin Content Area -->
    <div id="plugins-content" class="space-y-8">
        <!-- Installed Plugins Section (Always visible at top) -->
        <div id="installed-plugins-section">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-md font-medium text-gray-900">Installed Plugins</h3>
                <span id="installed-count" class="text-sm text-gray-500">0 installed</span>
            </div>
            <div id="installed-plugins-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                <!-- Plugins will be loaded here -->
            </div>
        </div>

        <!-- Plugin Store Section (Always visible at bottom) -->
        <div id="plugin-store-section" class="border-t border-gray-200 pt-8">
            <div class="flex items-center justify-between mb-4">
                <h3 class="text-md font-medium text-gray-900">Plugin Store</h3>
                <span id="store-count" class="text-sm text-gray-500">
                    <i class="fas fa-spinner fa-spin mr-1"></i>Loading...
                </span>
            </div>
            
            <!-- GitHub Auth Warning Banner (only shown when no token is configured) -->
            <div id="github-auth-warning" class="hidden mb-4 bg-yellow-50 border-l-4 border-yellow-400 p-4">
                <div class="flex">
                    <div class="flex-shrink-0">
                        <i class="fas fa-exclamation-triangle text-yellow-400"></i>
                    </div>
                    <div class="ml-3 flex-1">
                        <p class="text-sm text-yellow-700">
                            <strong>Limited API Access:</strong> GitHub API requests are limited to <span id="rate-limit-count">60</span> per hour without authentication.
                            Add a GitHub token to increase this to 5,000 requests/hour and get real-time plugin stats.
                        </p>
                        <p class="mt-2 text-sm text-yellow-700">
                            <a href="https://github.com/settings/tokens/new?description=LEDMatrix%20Plugin%20Manager&scopes=" target="_blank" class="font-medium underline hover:text-yellow-800">
                                Create a GitHub Token â†’
                            </a>
                            <span class="mx-2">|</span>
                            <a href="#" onclick="event.preventDefault(); toggleGithubTokenSettings()" class="font-medium underline hover:text-yellow-800">
                                Configure Token
                            </a>
                        </p>
                    </div>
                    <div class="flex-shrink-0">
                        <button onclick="dismissGithubWarning()" class="text-yellow-700 hover:text-yellow-900">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- GitHub Token Configuration Section -->
            <div id="github-token-settings" class="hidden mb-4 bg-blue-50 border border-blue-200 rounded-lg p-4">
                <div class="flex items-start justify-between mb-3">
                    <div class="flex items-center space-x-2">
                        <i class="fab fa-github text-blue-600 text-xl"></i>
                        <h4 class="font-semibold text-gray-900">GitHub API Configuration</h4>
                    </div>
                    <button onclick="toggleGithubTokenSettings()" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <p class="text-sm text-gray-600 mb-3">
                    Configure your GitHub Personal Access Token to increase API rate limits and get real-time plugin statistics.
                </p>

                <div class="space-y-3">
                    <div>
                        <label for="github-token-input" class="block text-sm font-medium text-gray-700 mb-1">
                            GitHub Personal Access Token
                        </label>
                        <div class="relative">
                            <input type="password" id="github-token-input" 
                                   class="w-full px-3 py-2 pr-20 border border-gray-300 rounded-md focus:ring-blue-500 focus:border-blue-500"
                                   placeholder="ghp_xxxxxxxxxxxxxxxxxxxx">
                            <button type="button" onclick="toggleGithubTokenVisibility()" 
                                    class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700">
                                <i id="github-token-icon" class="fas fa-eye"></i>
                            </button>
                        </div>
                        <p class="text-xs text-gray-500 mt-1">
                            Token is stored in config_secrets.json. No scopes required for public repositories.
                        </p>
                    </div>

                    <div class="flex items-center justify-between">
                        <a href="https://github.com/settings/tokens/new?description=LEDMatrix%20Plugin%20Manager&scopes=" 
                           target="_blank" 
                           class="text-sm text-blue-600 hover:text-blue-800">
                            <i class="fas fa-external-link-alt mr-1"></i>Create Token on GitHub
                        </a>
                        <div class="flex gap-2">
                            <button onclick="loadGithubToken()" class="px-3 py-1.5 text-sm bg-gray-600 hover:bg-gray-700 text-white rounded-md">
                                <i class="fas fa-sync mr-1"></i>Load Current
                            </button>
                            <button onclick="saveGithubToken()" class="px-4 py-1.5 text-sm bg-blue-600 hover:bg-blue-700 text-white rounded-md">
                                <i class="fas fa-save mr-1"></i>Save Token
                            </button>
                        </div>
                    </div>

                    <div class="bg-white border border-blue-200 rounded p-3">
                        <p class="text-xs text-gray-600">
                            <strong>Rate Limits:</strong><br>
                            Without token: 60 requests/hour<br>
                            With token: 5,000 requests/hour
                        </p>
                    </div>
                </div>
            </div>
            <div class="mb-4">
                <div class="flex gap-3">
                    <input type="text" id="plugin-search" placeholder="Search plugins by name, description, or tags..." class="form-control text-sm flex-[3] min-w-0 px-3 py-2 border border-gray-300 rounded-md">
                    <select id="plugin-category" class="form-control text-sm flex-1 px-2 py-2 border border-gray-300 rounded-md">
                        <option value="">All Categories</option>
                        <option value="sports">Sports</option>
                        <option value="content">Content</option>
                        <option value="time">Time</option>
                        <option value="weather">Weather</option>
                        <option value="financial">Financial</option>
                        <option value="media">Media</option>
                        <option value="demo">Demo</option>
                    </select>
                    <button id="search-plugins-btn" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md whitespace-nowrap">
                        <i class="fas fa-search mr-2"></i>Search
                    </button>
                </div>
            </div>
            <div id="plugin-store-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                <!-- Loading skeleton -->
                <div class="store-loading col-span-full">
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 2xl:grid-cols-5 gap-4">
                        <div class="bg-gray-200 rounded-lg p-4 h-48 animate-pulse"></div>
                        <div class="bg-gray-200 rounded-lg p-4 h-48 animate-pulse"></div>
                        <div class="bg-gray-200 rounded-lg p-4 h-48 animate-pulse"></div>
                        <div class="bg-gray-200 rounded-lg p-4 h-48 animate-pulse"></div>
                        <div class="bg-gray-200 rounded-lg p-4 h-48 animate-pulse"></div>
                </div>
            </div>
            </div>
        </div>
    </div>

    <!-- Plugin Configuration Modal -->
    <div id="plugin-config-modal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50" style="display: none;">
        <div class="bg-white rounded-lg p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-4">
                <h3 id="plugin-config-title" class="text-lg font-semibold">Plugin Configuration</h3>
                <button id="close-plugin-config" class="text-gray-400 hover:text-gray-600">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div id="plugin-config-content">
                <!-- Plugin config form will be loaded here -->
            </div>
        </div>
    </div>
</div>

<style>
/* Nested config section styles */
.nested-section {
    transition: all 0.2s ease;
}

.nested-section button:hover {
    background-color: #f3f4f6;
}

.nested-section .nested-content {
    transition: all 0.3s ease;
}

.nested-section i {
    transition: transform 0.3s ease;
}

/* Smooth toggle animation */
.nested-content[style*="display: none"] {
    opacity: 0;
    max-height: 0;
    overflow: hidden;
}

.nested-content[style*="display: block"] {
    opacity: 1;
    max-height: none;
}

/* Nested sections within nested sections - add indentation */
.nested-content .nested-section {
    margin-left: 1rem;
}

/* Form group spacing within nested sections */
.nested-content .form-group {
    margin-bottom: 0.75rem;
}

/* Make nested section headers slightly smaller for hierarchy */
.nested-content .nested-section h4 {
    font-size: 0.95em;
}
</style>

<script>
(function() {
    'use strict';

    console.log('Plugin manager script starting...');
    
    // Local variables for this instance
let installedPlugins = [];
let currentPluginConfig = null;
    let pluginStoreCache = null; // Cache for plugin store to speed up subsequent loads
    let cacheTimestamp = null;
    const CACHE_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds

// Initialize when DOM is ready or when HTMX loads content
window.initPluginsPage = function() {
    initializePlugins();

    // Event listeners (remove old ones first to prevent duplicates)
    const refreshBtn = document.getElementById('refresh-plugins-btn');
    const restartBtn = document.getElementById('restart-display-btn');
    const searchBtn = document.getElementById('search-plugins-btn');
    const closeBtn = document.getElementById('close-plugin-config');
    
    if (refreshBtn) {
        refreshBtn.replaceWith(refreshBtn.cloneNode(true));
        document.getElementById('refresh-plugins-btn').addEventListener('click', refreshPlugins);
    }
    if (restartBtn) {
        restartBtn.replaceWith(restartBtn.cloneNode(true));
        document.getElementById('restart-display-btn').addEventListener('click', restartDisplay);
    }
    if (searchBtn) {
        searchBtn.replaceWith(searchBtn.cloneNode(true));
        document.getElementById('search-plugins-btn').addEventListener('click', searchPluginStore);
    }
    if (closeBtn) {
        closeBtn.replaceWith(closeBtn.cloneNode(true));
        document.getElementById('close-plugin-config').addEventListener('click', closePluginConfigModal);
    }
}

// Initialize immediately when script loads (HTMX has already swapped content)
console.log('Plugin manager script loaded, initializing...');
// Small delay to ensure DOM is fully painted
setTimeout(function() {
    console.log('Checking for plugin elements...');
    if (document.getElementById('installed-plugins-grid')) {
        console.log('Plugin elements found, initializing now!');
        initPluginsPage();
    } else {
        console.error('Plugin elements not found!');
    }
}, 100);

function initializePlugins() {
    console.log('Initializing plugins...');

    // Check GitHub authentication status
    checkGitHubAuthStatus();

    // Load both installed plugins and plugin store
    loadInstalledPlugins();
    searchPluginStore(); // Load plugin store with no filters

    // Setup search functionality
    document.getElementById('plugin-search').addEventListener('input', debounce(searchPluginStore, 300));
    document.getElementById('plugin-category').addEventListener('change', searchPluginStore);

    console.log('Plugins initialized');
}

function loadInstalledPlugins() {
    console.log('Loading installed plugins...');

    fetch('/api/v3/plugins/installed')
        .then(response => {
            console.log('Installed plugins response:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Installed plugins data:', data);

            if (data.status === 'success') {
                installedPlugins = data.data.plugins || [];
                console.log('Installed plugins count:', installedPlugins.length);
                renderInstalledPlugins(installedPlugins);

                // Update count
                const countEl = document.getElementById('installed-count');
                if (countEl) {
                    countEl.textContent = installedPlugins.length + ' installed';
                }
            } else {
                showError('Failed to load installed plugins: ' + data.message);
            }
        })
        .catch(error => {
            console.error('Error loading installed plugins:', error);
            showError('Error loading plugins: ' + error.message);
        });
}

function renderInstalledPlugins(plugins) {
    const container = document.getElementById('installed-plugins-grid');
    
    // Update global installedPlugins for navigation tabs
    window.installedPlugins = plugins;
    console.log('Set window.installedPlugins to:', plugins.length, 'plugins');
    
    // Trigger the main app to update plugin tabs
    if (window.Alpine && document.querySelector('[x-data="app()"]')) {
        const appElement = document.querySelector('[x-data="app()"]');
        if (appElement && appElement._x_dataStack && appElement._x_dataStack[0]) {
            appElement._x_dataStack[0].installedPlugins = plugins;
            appElement._x_dataStack[0].updatePluginTabs();
            console.log('Triggered Alpine.js to update plugin tabs');
        }
    }

    if (plugins.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-8">
                <i class="fas fa-plug text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-600">No plugins installed</p>
                <p class="text-sm text-gray-500 mt-1">Install plugins from the store to get started</p>
            </div>
        `;
        return;
    }

    container.innerHTML = plugins.map(plugin => `
        <div class="bg-gray-50 rounded-lg p-4 border">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <h4 class="font-medium text-gray-900">${escapeHtml(plugin.name || plugin.id)}</h4>
                        ${plugin.verified ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">âœ“ Verified</span>' : ''}
                        ${plugin.enabled ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded ml-2">Enabled</span>' : '<span class="bg-gray-100 text-gray-800 text-xs px-2 py-1 rounded ml-2">Disabled</span>'}
                    </div>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p><i class="fas fa-user mr-1"></i>${escapeHtml(plugin.author || 'Unknown')}</p>
                        <p><i class="fas fa-code-branch mr-1"></i>v${plugin.version || '1.0.0'}</p>
                        <p><i class="fas fa-folder mr-1"></i>${escapeHtml(plugin.category || 'General')}</p>
                        <p><i class="fas fa-star mr-1"></i>${plugin.stars || 0} stars</p>
                    </div>
                    <p class="text-sm text-gray-700 mt-2">${escapeHtml(plugin.description || 'No description available')}</p>
                </div>
            </div>

            <!-- Plugin Tags -->
            ${plugin.tags ? `
                <div class="flex flex-wrap gap-1 mb-3">
                    ${plugin.tags.map(tag => `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${escapeHtml(tag)}</span>`).join('')}
                </div>
            ` : ''}

            <!-- Plugin Actions -->
            <div class="flex space-x-2">
                <button onclick="configurePlugin('${plugin.id}')"
                        class="btn bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded text-sm flex-1">
                    <i class="fas fa-cog mr-1"></i>Configure
                </button>
                <button onclick="updatePlugin('${plugin.id}')"
                        class="btn bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm flex-1">
                    <i class="fas fa-sync mr-1"></i>Update
                </button>
                <button onclick="uninstallPlugin('${plugin.id}')"
                        class="btn bg-red-600 hover:bg-red-700 text-white px-3 py-1 rounded text-sm flex-1">
                    <i class="fas fa-trash mr-1"></i>Uninstall
                </button>
            </div>
        </div>
    `).join('');
}

// Helper function to update toggle text dynamically
function updateToggleText(checkbox) {
    const statusText = document.getElementById('enabled-status-text');
    if (statusText) {
        statusText.textContent = checkbox.checked ? 'Enabled' : 'Disabled';
    }
}

window.configurePlugin = function(pluginId) {
    console.log('Switching to plugin tab:', pluginId);
    
    // Switch to the plugin's dedicated tab using Alpine.js
    const appElement = document.querySelector('[x-data="app()"]');
    if (appElement && appElement._x_dataStack && appElement._x_dataStack[0]) {
        appElement._x_dataStack[0].activeTab = pluginId;
        console.log('Switched to tab:', pluginId);
    } else {
        // Fallback: try to trigger the tab button click
        const pluginTab = document.querySelector(`.plugin-tab[onclick*="${pluginId}"]`);
        if (pluginTab) {
            pluginTab.click();
            console.log('Clicked plugin tab button');
        } else {
            console.error('Could not find plugin tab for:', pluginId);
            showNotification('Plugin tab not found. Please refresh the page.', 'error');
        }
    }
}

function showPluginConfigModal(pluginId, config) {
    const modal = document.getElementById('plugin-config-modal');
    const title = document.getElementById('plugin-config-title');
    const content = document.getElementById('plugin-config-content');

    console.log('Showing modal for:', pluginId);
    title.textContent = `Configure ${pluginId}`;
    
    // Show loading state while form is generated
    content.innerHTML = '<div class="flex items-center justify-center py-8"><i class="fas fa-spinner fa-spin text-2xl text-blue-600"></i></div>';
    
    // Show modal immediately
    modal.style.display = 'flex';
    console.log('Modal display set to flex');
    
    // Generate form asynchronously
    generatePluginConfigForm(pluginId, config)
        .then(formHtml => {
            console.log('Form generated, setting content');
            content.innerHTML = formHtml;
            
            // Attach form submit handler after form is inserted
            const form = document.getElementById('plugin-config-form');
            if (form) {
                form.addEventListener('submit', handlePluginConfigSubmit);
                console.log('Form submit handler attached');
            }
        })
        .catch(error => {
            console.error('Error generating config form:', error);
            content.innerHTML = '<p class="text-red-600">Error loading configuration form</p>';
        });
}

// Helper function to find property type in nested schema using dot notation
function getSchemaPropertyType(schema, path) {
    const parts = path.split('.');
    let current = schema;
    
    for (let i = 0; i < parts.length; i++) {
        if (!current || !current.properties) return null;
        current = current.properties[parts[i]];
        if (!current) return null;
        
        // If this is an object and not the last part, continue traversing
        if (i < parts.length - 1 && current.type === 'object') {
            continue;
        }
    }
    
    return current;
}

// Helper function to convert dot notation to nested object
function dotToNested(obj) {
    const result = {};
    
    for (const key in obj) {
        const parts = key.split('.');
        let current = result;
        
        for (let i = 0; i < parts.length - 1; i++) {
            if (!current[parts[i]]) {
                current[parts[i]] = {};
            }
            current = current[parts[i]];
        }
        
        current[parts[parts.length - 1]] = obj[key];
    }
    
    return result;
}

// Helper function to collect all boolean fields from schema (including nested)
function collectBooleanFields(schema, prefix = '') {
    const boolFields = [];
    
    if (!schema || !schema.properties) return boolFields;
    
    Object.entries(schema.properties).forEach(([key, prop]) => {
        const fullKey = prefix ? `${prefix}.${key}` : key;
        
        if (prop.type === 'boolean') {
            boolFields.push(fullKey);
        } else if (prop.type === 'object' && prop.properties) {
            boolFields.push(...collectBooleanFields(prop, fullKey));
        }
    });
    
    return boolFields;
}

function handlePluginConfigSubmit(e) {
    e.preventDefault();
    console.log('Form submitted');
    
    if (!currentPluginConfig) {
        showNotification('Plugin configuration not loaded', 'error');
        return;
    }
    
    const pluginId = currentPluginConfig.pluginId;
    const schema = currentPluginConfig.schema;
    const form = e.target;
    const formData = new FormData(form);
    const flatConfig = {};
    
    console.log('Schema loaded:', schema ? 'Yes' : 'No');
    
    // Process form data with type conversion (using dot notation for nested fields)
    for (const [key, value] of formData.entries()) {
        const propSchema = getSchemaPropertyType(schema, key);
        
        if (propSchema) {
            const propType = propSchema.type;
            
            if (propType === 'array') {
                // Convert comma-separated string to array
                const arrayValue = value ? value.split(',').map(v => v.trim()).filter(v => v) : [];
                flatConfig[key] = arrayValue;
                console.log(`Array field ${key}: "${value}" -> `, arrayValue);
            } else if (propType === 'integer') {
                flatConfig[key] = parseInt(value, 10);
            } else if (propType === 'number') {
                flatConfig[key] = parseFloat(value);
            } else if (propType === 'boolean') {
                flatConfig[key] = form.elements[key].checked;
            } else {
                flatConfig[key] = value;
            }
        } else {
            // No schema, try to infer type
            if (form.elements[key] && form.elements[key].type === 'checkbox') {
                flatConfig[key] = form.elements[key].checked;
            } else {
                flatConfig[key] = value;
            }
        }
    }
    
    // Handle unchecked checkboxes (not in FormData) - including nested ones
    if (schema && schema.properties) {
        const allBoolFields = collectBooleanFields(schema);
        allBoolFields.forEach(key => {
            if (!(key in flatConfig)) {
                flatConfig[key] = false;
            }
        });
    }
    
    // Convert dot notation to nested object
    const config = dotToNested(flatConfig);
    
    console.log('Flat config:', flatConfig);
    console.log('Nested config to save:', config);
    
    // Save the configuration
    fetch('/api/v3/plugins/config', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
            plugin_id: pluginId,
            config: config
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'success') {
            showNotification('Configuration saved successfully', 'success');
            closePluginConfigModal();
            loadInstalledPlugins(); // Refresh to show updated config
        } else {
            showNotification('Error saving configuration: ' + data.message, 'error');
        }
    })
    .catch(error => {
        console.error('Error saving plugin config:', error);
        showNotification('Error saving configuration: ' + error.message, 'error');
    });
}

function generatePluginConfigForm(pluginId, config) {
    // Load plugin schema for dynamic form generation
    return fetch(`/api/v3/plugins/schema?plugin_id=${pluginId}`)
        .then(response => response.json())
        .then(schemaData => {
            if (schemaData.status === 'success' && schemaData.data.schema) {
                // Store plugin ID and schema for form submission
                currentPluginConfig = {
                    pluginId: pluginId,
                    schema: schemaData.data.schema
                };
                return generateFormFromSchema(schemaData.data.schema, config);
            } else {
                // Fallback to simple form if no schema
                currentPluginConfig = { pluginId: pluginId, schema: null };
                return generateSimpleConfigForm(config);
            }
        })
        .catch(error => {
            console.error('Error loading schema:', error);
            currentPluginConfig = { pluginId: pluginId, schema: null };
            return generateSimpleConfigForm(config);
        });
}

// Helper to flatten nested config for form display (converts {nfl: {enabled: true}} to {'nfl.enabled': true})
function flattenConfig(obj, prefix = '') {
    let result = {};
    
    for (const key in obj) {
        const value = obj[key];
        const fullKey = prefix ? `${prefix}.${key}` : key;
        
        if (value !== null && typeof value === 'object' && !Array.isArray(value)) {
            // Recursively flatten nested objects
            Object.assign(result, flattenConfig(value, fullKey));
        } else {
            result[fullKey] = value;
        }
    }
    
    return result;
}

// Generate field HTML for a single property (used recursively)
function generateFieldHtml(key, prop, value, prefix = '') {
    const fullKey = prefix ? `${prefix}.${key}` : key;
    const label = prop.title || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
    const description = prop.description || '';
    let html = '';

    // Handle nested objects
    if (prop.type === 'object' && prop.properties) {
        const sectionId = `section-${fullKey.replace(/\./g, '-')}`;
        const nestedConfig = value || {};
        const sectionLabel = prop.title || key.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
        
        html += `
            <div class="nested-section border border-gray-300 rounded-lg overflow-hidden mb-4">
                <button type="button" 
                        class="w-full bg-gray-100 hover:bg-gray-200 px-4 py-3 flex items-center justify-between text-left transition-colors"
                        onclick="toggleNestedSection('${sectionId}')">
                    <div class="flex-1">
                        <h4 class="font-semibold text-gray-900">${sectionLabel}</h4>
                        ${description ? `<p class="text-sm text-gray-600 mt-1">${description}</p>` : ''}
                    </div>
                    <i id="${sectionId}-icon" class="fas fa-chevron-down text-gray-500 transition-transform"></i>
                </button>
                <div id="${sectionId}" class="nested-content bg-gray-50 px-4 py-3 space-y-3" style="display: block;">
        `;
        
        // Recursively generate fields for nested properties
        Object.entries(prop.properties).forEach(([nestedKey, nestedProp]) => {
            const nestedValue = nestedConfig[nestedKey] !== undefined ? nestedConfig[nestedKey] : nestedProp.default;
            html += generateFieldHtml(nestedKey, nestedProp, nestedValue, fullKey);
        });
        
        html += `
                </div>
            </div>
        `;
        
        return html;
    }

    // Regular (non-nested) field
    html += `
        <div class="form-group">
            <label for="${fullKey}" class="block text-sm font-medium text-gray-700 mb-1">
                ${label}
            </label>
    `;

    if (description) {
        html += `<p class="text-sm text-gray-600 mb-2">${description}</p>`;
    }

    // Generate appropriate input based on type
    if (prop.type === 'boolean') {
        html += `
            <label class="flex items-center">
                <input type="checkbox" id="${fullKey}" name="${fullKey}" ${value ? 'checked' : ''} class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                <span class="ml-2 text-sm">Enabled</span>
            </label>
        `;
    } else if (prop.type === 'number' || prop.type === 'integer') {
        const min = prop.minimum !== undefined ? `min="${prop.minimum}"` : '';
        const max = prop.maximum !== undefined ? `max="${prop.maximum}"` : '';
        const step = prop.type === 'integer' ? 'step="1"' : 'step="any"';
        html += `
            <input type="number" id="${fullKey}" name="${fullKey}" value="${value !== undefined ? value : ''}" ${min} ${max} ${step} class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
        `;
    } else if (prop.type === 'array') {
        const arrayValue = Array.isArray(value) ? value.join(', ') : '';
        html += `
            <input type="text" id="${fullKey}" name="${fullKey}" value="${arrayValue}" placeholder="Enter values separated by commas" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
            <p class="text-sm text-gray-600 mt-1">Enter values separated by commas</p>
        `;
    } else if (prop.enum) {
        html += `<select id="${fullKey}" name="${fullKey}" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">`;
        prop.enum.forEach(option => {
            const selected = value === option ? 'selected' : '';
            html += `<option value="${option}" ${selected}>${option}</option>`;
        });
        html += `</select>`;
    } else {
        // Check if this is a secret field
        const isSecret = prop['x-secret'] === true;
        const inputType = isSecret ? 'password' : 'text';
        const maxLength = prop.maxLength || '';
        
        html += `
            <div class="relative">
                <input type="${inputType}" id="${fullKey}" name="${fullKey}" value="${value !== undefined ? value : ''}" ${maxLength ? `maxlength="${maxLength}"` : ''} class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm ${isSecret ? 'pr-10' : ''}">
        `;
        
        if (isSecret) {
            html += `
                <button type="button" onclick="togglePasswordVisibility('${fullKey}')" class="absolute inset-y-0 right-0 pr-3 flex items-center text-gray-500 hover:text-gray-700">
                    <i id="${fullKey}-icon" class="fas fa-eye"></i>
                </button>
            `;
        }
        
        html += `</div>`;
    }

    html += `</div>`;
    
    return html;
}

function generateFormFromSchema(schema, config) {
    let formHtml = '<form id="plugin-config-form" class="space-y-4">';

    // Always add the enabled toggle at the top
    const enabledValue = config.enabled !== undefined ? config.enabled : true;
    formHtml += `
        <div class="form-group bg-blue-50 p-4 rounded-lg border border-blue-200">
            <label for="enabled" class="block text-sm font-medium text-gray-900 mb-2">
                Plugin Status
            </label>
            <p class="text-sm text-gray-600 mb-3">Enable or disable this plugin from the rotation</p>
            <label class="inline-flex items-center cursor-pointer">
                <input type="checkbox" id="enabled" name="enabled" ${enabledValue ? 'checked' : ''} class="sr-only peer" onchange="updateToggleText(this)">
                <div class="relative w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                <span class="ms-3 text-sm font-medium text-gray-900 peer-checked:text-green-600" id="enabled-status-text">${enabledValue ? 'Enabled' : 'Disabled'}</span>
            </label>
        </div>
    `;

    if (schema.properties) {
        Object.entries(schema.properties).forEach(([key, prop]) => {
            // Skip the 'enabled' property if it's in the schema since we already added it
            if (key === 'enabled') return;

            const value = config[key] !== undefined ? config[key] : prop.default;
            formHtml += generateFieldHtml(key, prop, value);
        });
    }

    formHtml += `
        <div class="flex justify-end space-x-2 pt-4 border-t border-gray-200">
            <button type="button" onclick="closePluginConfigModal()" class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2 rounded-md">
                Cancel
            </button>
            <button type="submit" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                <i class="fas fa-save mr-2"></i>Save Configuration
            </button>
        </div>
    </form>
    `;

    return Promise.resolve(formHtml);
}

// Function to toggle nested sections
window.toggleNestedSection = function(sectionId) {
    const content = document.getElementById(sectionId);
    const icon = document.getElementById(sectionId + '-icon');
    
    // Check if content is hidden (handle both explicit 'none' and empty string for initial state)
    const isHidden = content.style.display === 'none';
    
    if (isHidden) {
        // Show the section
        content.style.display = 'block';
        icon.classList.remove('fa-chevron-right');
        icon.classList.add('fa-chevron-down');
    } else {
        // Hide the section
        content.style.display = 'none';
        icon.classList.remove('fa-chevron-down');
        icon.classList.add('fa-chevron-right');
    }
}

function generateSimpleConfigForm(config) {
    const enabledValue = config.enabled !== undefined ? config.enabled : true;
    return `
        <form id="plugin-config-form" class="space-y-4">
            <div class="form-group bg-blue-50 p-4 rounded-lg border border-blue-200">
                <label for="enabled" class="block text-sm font-medium text-gray-900 mb-2">
                    Plugin Status
                </label>
                <p class="text-sm text-gray-600 mb-3">Enable or disable this plugin from the rotation</p>
                <label class="inline-flex items-center cursor-pointer">
                    <input type="checkbox" id="enabled" name="enabled" ${enabledValue ? 'checked' : ''} class="sr-only peer" onchange="updateToggleText(this)">
                    <div class="relative w-11 h-6 bg-gray-300 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full rtl:peer-checked:after:-translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:start-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                    <span class="ms-3 text-sm font-medium text-gray-900 peer-checked:text-green-600" id="enabled-status-text">${enabledValue ? 'Enabled' : 'Disabled'}</span>
                </label>
            </div>

            <div class="form-group">
                <label class="block text-sm font-medium text-gray-700 mb-1">Configuration</label>
                <textarea name="config" class="form-control h-32" placeholder="Plugin configuration JSON">${JSON.stringify(config, null, 2)}</textarea>
            </div>

            <div class="flex justify-end space-x-2">
                <button type="button" onclick="closePluginConfigModal()" class="btn bg-gray-600 hover:bg-gray-700 text-white px-4 py-2">
                    Cancel
                </button>
                <button type="submit" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2">
                    Save Configuration
                </button>
            </div>
        </form>
    `;
}

window.closePluginConfigModal = function() {
        const modal = document.getElementById('plugin-config-modal');
    modal.style.display = 'none';
        currentPluginConfig = null;
    console.log('Modal closed');
}

window.updatePlugin = function(pluginId) {
    showNotification(`Updating ${pluginId}...`, 'info');

    fetch('/api/v3/plugins/update', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plugin_id: pluginId })
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message, data.status);
        if (data.status === 'success') {
            loadInstalledPlugins(); // Refresh the list
        }
    })
    .catch(error => {
        showNotification('Error updating plugin: ' + error.message, 'error');
    });
}

window.uninstallPlugin = function(pluginId) {
    const plugin = installedPlugins.find(p => p.id === pluginId);
    const pluginName = plugin ? (plugin.name || pluginId) : pluginId;

    if (!confirm(`Are you sure you want to uninstall ${pluginName}?`)) {
        return;
    }

    showNotification(`Uninstalling ${pluginName}...`, 'info');

    fetch('/api/v3/plugins/uninstall', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plugin_id: pluginId })
    })
    .then(response => response.json())
    .then(data => {
        console.log('Uninstall response:', data);
        showNotification(data.message, data.status);
        if (data.status === 'success') {
            // Remove from local array immediately for better UX
            installedPlugins = installedPlugins.filter(p => p.id !== pluginId);
            renderInstalledPlugins(installedPlugins);

            // Also refresh from server to ensure consistency
            setTimeout(() => {
                loadInstalledPlugins();
            }, 1000);
        }
    })
    .catch(error => {
        console.error('Error uninstalling plugin:', error);
        showNotification('Error uninstalling plugin: ' + error.message, 'error');
    });
}

function refreshPlugins() {
    // Clear cache to force fresh data
    pluginStoreCache = null;
    cacheTimestamp = null;
    
    loadInstalledPlugins();
    searchPluginStore();
    showNotification('Plugins refreshed', 'success');
}

function restartDisplay() {
    fetch('/api/v3/system/action', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ action: 'start_display' })
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message, data.status);
    })
    .catch(error => {
        showNotification('Error restarting display: ' + error.message, 'error');
    });
}

function searchPluginStore() {
    console.log('Searching plugin store...');
    const query = document.getElementById('plugin-search').value;
    const category = document.getElementById('plugin-category').value;

    // Check if we can use cached data (only for non-filtered requests)
    const now = Date.now();
    const isCacheValid = pluginStoreCache && cacheTimestamp && (now - cacheTimestamp < CACHE_DURATION);
    
    if (!query && !category && isCacheValid) {
        console.log('Using cached plugin store data');
        renderPluginStore(pluginStoreCache);
        const countEl = document.getElementById('store-count');
        if (countEl) {
            countEl.innerHTML = `${pluginStoreCache.length} available`;
        }
        return;
    }

    // Show loading state
    const countEl = document.getElementById('store-count');
    if (countEl) {
        countEl.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Loading...';
    }
    showStoreLoading(true);

    let url = '/api/v3/plugins/store/list';
    const params = new URLSearchParams();
    if (query) params.append('query', query);
    if (category) params.append('category', category);

    if (params.toString()) {
        url += '?' + params.toString();
    }

    console.log('Store URL:', url);

    fetch(url)
        .then(response => {
            console.log('Store response:', response.status);
            return response.json();
        })
        .then(data => {
            console.log('Store data:', data);
            showStoreLoading(false);
            
            if (data.status === 'success') {
                const plugins = data.data.plugins || [];
                console.log('Store plugins count:', plugins.length);
                
                // Cache the results if no filters
                if (!query && !category) {
                    pluginStoreCache = plugins;
                    cacheTimestamp = Date.now();
                    console.log('Cached plugin store data');
                }
                
                renderPluginStore(plugins);

                // Update count
                if (countEl) {
                    countEl.innerHTML = `${plugins.length} available`;
                }
            } else {
                showError('Failed to search plugin store: ' + data.message);
                if (countEl) {
                    countEl.innerHTML = 'Error loading';
                }
            }
        })
        .catch(error => {
            console.error('Error searching plugin store:', error);
            showStoreLoading(false);
            showError('Error searching plugin store: ' + error.message);
            if (countEl) {
                countEl.innerHTML = 'Error loading';
            }
        });
}

function showStoreLoading(show) {
    const loading = document.querySelector('.store-loading');
    if (loading) {
        loading.style.display = show ? 'block' : 'none';
    }
}

function renderPluginStore(plugins) {
    const container = document.getElementById('plugin-store-grid');

    if (plugins.length === 0) {
        container.innerHTML = `
            <div class="col-span-full text-center py-8">
                <i class="fas fa-store text-4xl text-gray-400 mb-2"></i>
                <p class="text-gray-600">No plugins found</p>
                <p class="text-sm text-gray-500 mt-1">Try adjusting your search criteria</p>
            </div>
        `;
        return;
    }

    container.innerHTML = plugins.map(plugin => `
        <div class="bg-gray-50 rounded-lg p-4 border">
            <div class="flex items-start justify-between mb-3">
                <div class="flex-1">
                    <div class="flex items-center space-x-2 mb-1">
                        <h4 class="font-medium text-gray-900">${escapeHtml(plugin.name || plugin.id)}</h4>
                        ${plugin.verified ? '<span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded">âœ“ Verified</span>' : ''}
                        ${isNewPlugin(plugin.last_updated) ? '<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">âœ¨ New</span>' : ''}
                    </div>
                    <div class="text-sm text-gray-600 space-y-1">
                        <p><i class="fas fa-user mr-1"></i>${escapeHtml(plugin.author || 'Unknown')}</p>
                        <p><i class="fas fa-code-branch mr-1"></i>v${plugin.versions && plugin.versions[0] ? plugin.versions[0].version : '1.0.0'}</p>
                        <p><i class="fas fa-calendar mr-1"></i>${formatDate(plugin.last_updated)}</p>
                        <p><i class="fas fa-tag mr-1"></i>${escapeHtml(plugin.category || 'General')}</p>
                        <p><i class="fas fa-star mr-1"></i>${plugin.stars || 0} stars</p>
                    </div>
                    <p class="text-sm text-gray-700 mt-2">${escapeHtml(plugin.description || 'No description available')}</p>
                </div>
            </div>

            <!-- Plugin Tags -->
            ${plugin.tags ? `
                <div class="flex flex-wrap gap-1 mb-3">
                    ${plugin.tags.map(tag => `<span class="bg-blue-100 text-blue-800 text-xs px-2 py-1 rounded">${escapeHtml(tag)}</span>`).join('')}
                </div>
            ` : ''}

            <!-- Store Actions -->
            <div class="flex space-x-2">
                <button onclick="installPlugin('${plugin.id}')"
                        class="btn bg-green-600 hover:bg-green-700 text-white px-3 py-1 rounded text-sm flex-1">
                    <i class="fas fa-download mr-1"></i>Install
                </button>
                <button onclick="window.open('${plugin.repo || '#'}', '_blank')"
                        class="btn bg-gray-600 hover:bg-gray-700 text-white px-3 py-1 rounded text-sm flex-1">
                    <i class="fas fa-external-link-alt mr-1"></i>View
                </button>
            </div>
        </div>
    `).join('');
}

// Expose functions to window for onclick handlers
window.installPlugin = function(pluginId) {
    showNotification(`Installing ${pluginId}...`, 'info');

    fetch('/api/v3/plugins/install', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ plugin_id: pluginId })
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message, data.status);
        if (data.status === 'success') {
            // Refresh both installed plugins and store
            loadInstalledPlugins();
            searchPluginStore();
        }
    })
    .catch(error => {
        showNotification('Error installing plugin: ' + error.message, 'error');
    });
}

function showError(message) {
    const content = document.getElementById('plugins-content');
    if (!content) {
        console.error('plugins-content element not found');
        showNotification(message, 'error');
        return;
    }
    content.innerHTML = `
        <div class="text-center py-8">
            <i class="fas fa-exclamation-triangle text-4xl text-red-400 mb-2"></i>
            <p class="text-red-600">${escapeHtml(message)}</p>
        </div>
    `;
}

// Plugin configuration form submission
document.addEventListener('submit', function(e) {
    if (e.target.id === 'plugin-config-form') {
        e.preventDefault();

        const formData = new FormData(e.target);
        const config = {};
        const schema = currentPluginConfig?.schema;

        // Get the enabled checkbox state (unchecked checkboxes don't appear in FormData)
        const enabledCheckbox = document.getElementById('enabled');
        config.enabled = enabledCheckbox ? enabledCheckbox.checked : true;

        // Convert form data to config object
        for (let [key, value] of formData.entries()) {
            // Skip enabled since we already handled it
            if (key === 'enabled') continue;

            // Check if this field is an array type in the schema
            if (schema?.properties?.[key]?.type === 'array') {
                // Convert comma-separated string to array
                const arrayValue = value.split(',').map(item => item.trim()).filter(item => item.length > 0);
                config[key] = arrayValue;
                console.log(`Array field ${key}: "${value}" -> `, arrayValue);
            } else if (key === 'display_duration' || schema?.properties?.[key]?.type === 'integer') {
                config[key] = parseInt(value);
            } else if (schema?.properties?.[key]?.type === 'number') {
                config[key] = parseFloat(value);
            } else if (schema?.properties?.[key]?.type === 'boolean') {
                config[key] = value === 'true' || value === true;
            } else {
                config[key] = value;
            }
        }

        console.log('Final config to save:', config);
        console.log('Schema loaded:', schema ? 'Yes' : 'No');

        // Save the configuration
        savePluginConfiguration(currentPluginConfig.pluginId, config);
    }
});

function savePluginConfiguration(pluginId, config) {
    // Update the plugin configuration in the backend
    fetch('/api/v3/plugins/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ plugin_id: pluginId, config })
    })
    .then(response => response.json())
    .then(data => {
        showNotification(data.message, data.status);
        if (data.status === 'success') {
            closePluginConfigModal();
            // Refresh the installed plugins to update the UI
            loadInstalledPlugins();
        }
    })
    .catch(error => {
        showNotification('Error saving plugin configuration: ' + error.message, 'error');
    });
}

// Utility function to escape HTML
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// Format date for display
function formatDate(dateString) {
    if (!dateString) return 'Unknown';
    
    try {
        const date = new Date(dateString);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        if (diffDays < 1) {
            return 'Today';
        } else if (diffDays < 2) {
            return 'Yesterday';
        } else if (diffDays < 7) {
            return `${diffDays} days ago`;
        } else if (diffDays < 30) {
            const weeks = Math.floor(diffDays / 7);
            return `${weeks} ${weeks === 1 ? 'week' : 'weeks'} ago`;
        } else {
            // Return formatted date for older items
            return date.toLocaleDateString('en-US', { year: 'numeric', month: 'short', day: 'numeric' });
        }
    } catch (e) {
        return dateString;
    }
}

// Check if plugin is new (updated within last 7 days)
function isNewPlugin(lastUpdated) {
    if (!lastUpdated) return false;
    
    try {
        const date = new Date(lastUpdated);
        const now = new Date();
        const diffTime = Math.abs(now - date);
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        return diffDays <= 7;
    } catch (e) {
        return false;
    }
}

// Debounce utility
function debounce(func, wait) {
    let timeout;
    return function executedFunction(...args) {
        const later = () => {
            clearTimeout(timeout);
            func(...args);
        };
        clearTimeout(timeout);
        timeout = setTimeout(later, wait);
    };
}

// Toggle password visibility for secret fields
function togglePasswordVisibility(fieldId) {
    const input = document.getElementById(fieldId);
    const icon = document.getElementById(fieldId + '-icon');
    
    if (input && icon) {
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
}

// GitHub Token Configuration Functions
window.toggleGithubTokenSettings = function() {
    const settings = document.getElementById('github-token-settings');
    if (settings) {
        settings.classList.toggle('hidden');
        if (!settings.classList.contains('hidden')) {
            loadGithubToken();
        }
    }
}

window.toggleGithubTokenVisibility = function() {
    const input = document.getElementById('github-token-input');
    const icon = document.getElementById('github-token-icon');
    
    if (input && icon) {
        if (input.type === 'password') {
            input.type = 'text';
            icon.classList.remove('fa-eye');
            icon.classList.add('fa-eye-slash');
        } else {
            input.type = 'password';
            icon.classList.remove('fa-eye-slash');
            icon.classList.add('fa-eye');
        }
    }
}

window.loadGithubToken = function() {
    fetch('/api/v3/config/secrets')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const token = data.data?.github?.api_token || '';
                const input = document.getElementById('github-token-input');
                if (input) {
                    input.value = token;
                    if (token && token !== 'YOUR_GITHUB_PERSONAL_ACCESS_TOKEN') {
                        showNotification('GitHub token loaded successfully', 'success');
                    } else {
                        showNotification('No GitHub token configured', 'info');
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error loading GitHub token:', error);
            showNotification('Error loading GitHub token', 'error');
        });
}

window.saveGithubToken = function() {
    const input = document.getElementById('github-token-input');
    if (!input) return;
    
    const token = input.value.trim();
    
    if (!token) {
        showNotification('Please enter a GitHub token', 'error');
        return;
    }
    
    // Load current secrets config
    fetch('/api/v3/config/secrets')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const secrets = data.data || {};
                
                // Update GitHub token
                if (!secrets.github) {
                    secrets.github = {};
                }
                secrets.github.api_token = token;
                
                // Save updated secrets
                return fetch('/api/v3/config/raw/secrets', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(secrets)
                });
            } else {
                throw new Error('Failed to load current secrets');
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                showNotification('GitHub token saved successfully! Rate limit increased to 5,000/hour', 'success');
                // Hide the warning banner
                const warning = document.getElementById('github-auth-warning');
                if (warning) {
                    warning.classList.add('hidden');
                }
                // Hide the settings panel after successful save
                setTimeout(() => {
                    toggleGithubTokenSettings();
                }, 2000);
            } else {
                showNotification('Error saving GitHub token: ' + data.message, 'error');
            }
        })
        .catch(error => {
            console.error('Error saving GitHub token:', error);
            showNotification('Error saving GitHub token: ' + error.message, 'error');
        });
}

// GitHub Authentication Status
// Only shows the warning banner if no GitHub token is configured
// The token itself is never exposed to the frontend for security
function checkGitHubAuthStatus() {
    fetch('/api/v3/plugins/store/github-status')
        .then(response => response.json())
        .then(data => {
            if (data.status === 'success') {
                const authData = data.data;

                // Only show the banner if no GitHub token is configured
                if (!authData.authenticated) {
                    // Check if user has dismissed the warning (stored in session storage)
                    const dismissed = sessionStorage.getItem('github-auth-warning-dismissed');
                    if (!dismissed) {
                        const warning = document.getElementById('github-auth-warning');
                        const rateLimit = document.getElementById('rate-limit-count');

                        if (warning && rateLimit) {
                            rateLimit.textContent = authData.rate_limit;
                            warning.classList.remove('hidden');
                            console.log('GitHub token not configured - showing API limit warning');
                        }
                    }
                } else {
                    // Token is configured - ensure the banner is hidden
                    const warning = document.getElementById('github-auth-warning');
                    if (warning) {
                        warning.classList.add('hidden');
                        console.log('GitHub token is configured - API limit warning hidden');
                    }
                    
                    // Also hide the GitHub token settings panel if it's visible
                    const settings = document.getElementById('github-token-settings');
                    if (settings && !settings.classList.contains('hidden')) {
                        settings.classList.add('hidden');
                        console.log('GitHub token is configured - hiding settings panel');
                    }
                }
            }
        })
        .catch(error => {
            console.error('Error checking GitHub auth status:', error);
        });
}

window.dismissGithubWarning = function() {
    const warning = document.getElementById('github-auth-warning');
    if (warning) {
        warning.classList.add('hidden');
        // Remember dismissal for this session
        sessionStorage.setItem('github-auth-warning-dismissed', 'true');
    }
}

window.showGithubTokenInstructions = function() {
    const instructions = `
        <div class="space-y-4">
            <h4 class="font-semibold text-lg">How to Add a GitHub Token</h4>
            
            <div class="space-y-3">
                <div class="bg-gray-50 p-3 rounded">
                    <h5 class="font-medium mb-2">Step 1: Create a GitHub Token</h5>
                    <ol class="list-decimal list-inside space-y-1 text-sm">
                        <li>Click the "Create a GitHub Token" link above (or <a href="https://github.com/settings/tokens/new?description=LEDMatrix%20Plugin%20Manager&scopes=" target="_blank" class="text-blue-600 underline">click here</a>)</li>
                        <li>Give it a name like "LEDMatrix Plugin Manager"</li>
                        <li>No special scopes/permissions are needed for public repositories</li>
                        <li>Click "Generate token" at the bottom</li>
                        <li>Copy the generated token (it starts with "ghp_")</li>
                    </ol>
                </div>
                
                <div class="bg-gray-50 p-3 rounded">
                    <h5 class="font-medium mb-2">Step 2: Add Token to LEDMatrix</h5>
                    <ol class="list-decimal list-inside space-y-1 text-sm">
                        <li>SSH into your Raspberry Pi</li>
                        <li>Edit the secrets file: <code class="bg-gray-200 px-1 rounded">nano ~/LEDMatrix/config/config_secrets.json</code></li>
                        <li>Find the "github" section and add your token:
                            <pre class="bg-gray-800 text-white p-2 rounded mt-2 text-xs overflow-x-auto">"github": {
  "api_token": "ghp_your_token_here"
}</pre>
                        </li>
                        <li>Save the file (Ctrl+O, Enter, Ctrl+X)</li>
                        <li>Restart the web service: <code class="bg-gray-200 px-1 rounded">sudo systemctl restart ledmatrix-web</code></li>
                    </ol>
                </div>
                
                <div class="bg-blue-50 p-3 rounded border border-blue-200">
                    <p class="text-sm text-blue-800">
                        <i class="fas fa-info-circle mr-2"></i>
                        <strong>Note:</strong> Your token is stored locally and never shared. It's only used to authenticate API requests to GitHub.
                    </p>
                </div>
            </div>
            
            <div class="flex justify-end">
                <button onclick="closeInstructionsModal()" class="btn bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md">
                    Got it!
                </button>
            </div>
        </div>
    `;
    
    // Use the existing plugin config modal for instructions
    const modal = document.getElementById('plugin-config-modal');
    const title = document.getElementById('plugin-config-title');
    const content = document.getElementById('plugin-config-content');
    
    title.textContent = 'GitHub Token Setup';
    content.innerHTML = instructions;
    modal.style.display = 'flex';
    console.log('GitHub instructions modal opened');
}

window.closeInstructionsModal = function() {
    const modal = document.getElementById('plugin-config-modal');
    modal.style.display = 'none';
    console.log('Instructions modal closed');
}

})(); // End IIFE
</script>
